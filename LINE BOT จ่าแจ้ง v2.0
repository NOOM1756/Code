// ====================================================================
// LINE BOT ‡∏à‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏´‡∏≤‡∏£ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: Performance, Security, Features, Error Handling
// ====================================================================

const CHANNEL_ACCESS_TOKEN = 'eCaIGNhvRTfGaVBxW9pAp2P5WSK7QGoB7/xePOUoJrgYoggex9Iz7nGqjpevJC/281jaC9xW4SFq75b+5CEvVsl/07NXXecUYG/tGeVvEuj0yPp0Np00wRTNU/OVYoQCH/ib4lFqvAt8pp6tqJOBxAdB04t89/1O/w1cDnyilFU=';
const MAX_MESSAGE_LENGTH = 5000; // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
const MAX_SEARCH_RESULTS = 10; // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤

// Cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢
const CACHE = {
  loginData: null,
  adminData: null,
  lastCacheUpdate: null,
  CACHE_DURATION: 5 * 60 * 1000 // 5 ‡∏ô‡∏≤‡∏ó‡∏µ
};

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å LINE
 */
function doPost(e) {
  try {
    const event = JSON.parse(e.postData.contents).events[0];
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó event
    if (event.type !== 'message' || event.message.type !== 'text') {
      return;
    }
    
    const userId = event.source.userId;
    const text = event.message.text.trim();
    
    // Log ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    logUserActivity(userId, text);
    
    // Route ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á ‡πÜ
    routeCommand(userId, text, event);
    
  } catch (error) {
    Logger.log(`Error in doPost: ${error.message}`);
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏´‡πâ admin
    notifyAdminError(error);
  }
}

/**
 * Route ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
 */
function routeCommand(userId, text, event) {
  const commands = {
    // Authentication
    '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô': () => handleRegistration(userId, text),
    
    // Personal Info
    '/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô': () => handleCommandChildInfo(event),
    '/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô': () => handleCommandPersonnelInfo(event),
    '/‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå': () => handleUserProfile(event), // ‡πÉ‡∏´‡∏°‡πà
    
    // Duty System
    '/‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô': () => handleCommandDutyToday(event),
    '/‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô': () => handleMonthlyDuty(event),
    '/‡πÄ‡∏ß‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á': () => handlePastDuties(event),
    '/‡πÄ‡∏ß‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ': () => handleUpcomingDuties(event), // ‡πÉ‡∏´‡∏°‡πà
    
    // Personnel Management (Admin)
    '/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•': () => handleAddPersonnel(userId, text),
    '/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•': () => handleEditPersonnel(userId, text),
    '/‡∏•‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•': () => handleDeletePersonnel(userId, text),
    '/‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î': () => handleViewAllPersonnel(event),
    '/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•': () => handleSearchPersonnel(userId, text), // ‡πÉ‡∏´‡∏°‡πà
    
    // Children Management
    '/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£': () => handleAddChild(userId, text),
    '/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏ï‡∏£': () => handleEditChild(userId, text),
    '/‡∏•‡∏ö‡∏ö‡∏∏‡∏ï‡∏£': () => handleDeleteChild(userId, text),
    '/‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î': () => handleViewAllChildren(event),
    
    // Duty Management (Admin)
    '/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£': () => handleAddDuty(userId, text),
    '/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏£': () => handleEditDuty(userId, text),
    '/‡∏•‡∏ö‡πÄ‡∏ß‡∏£': () => handleDeleteDuty(userId, text),
    '/‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î': () => handleViewAllDuties(event),
    '/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£': () => handleCreateDutySchedule(userId, text), // ‡πÉ‡∏´‡∏°‡πà
    
    // Command Book Management
    '/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á': () => handleAddCommand(userId, text),
    '/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á': () => handleEditCommand(userId, text),
    '/‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á': () => handleDeleteCommand(userId, text),
    '/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á': () => handleSearchCommand(userId, text),
    
    // Reports
    '/‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢': () => handleCompanyChildrenReport(event),
    '/‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô': () => handleGenerateReport(event),
    '/‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô': () => handleMonthlyDutyReport(event), // ‡πÉ‡∏´‡∏°‡πà
    '/‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô': () => handleUsageStatistics(event), // ‡πÉ‡∏´‡∏°‡πà
    
    // Notifications
    '/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô': () => handleNotificationSettings(userId, text), // ‡πÉ‡∏´‡∏°‡πà
    '/‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô': () => handleTestNotification(userId), // ‡πÉ‡∏´‡∏°‡πà
    
    // System
    '/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö': () => handleSystemStatus(userId), // ‡πÉ‡∏´‡∏°‡πà
    '/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô': () => handleVersionInfo(userId), // ‡πÉ‡∏´‡∏°‡πà
    '/‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠': () => sendReply(userId, getHelpMessage()),
    '/help': () => sendReply(userId, getHelpMessage())
  };
  
  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
  for (const [command, handler] of Object.entries(commands)) {
    if (text.startsWith(command)) {
      handler();
      return;
    }
  }
  
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  sendReply(userId, getSmartHelpMessage(text));
}

/**
 * ‡∏£‡∏∞‡∏ö‡∏ö Cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
 */
function getCachedData(type) {
  const now = new Date().getTime();
  
  if (CACHE.lastCacheUpdate && (now - CACHE.lastCacheUpdate) < CACHE.CACHE_DURATION) {
    return CACHE[type];
  }
  
  // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Cache
  refreshCache();
  return CACHE[type];
}

function refreshCache() {
  try {
    const loginSheet = SpreadsheetApp.getActive().getSheetByName('LOGIN');
    const adminSheet = SpreadsheetApp.getActive().getSheetByName('ADMIN');
    
    CACHE.loginData = loginSheet ? loginSheet.getDataRange().getValues() : [];
    CACHE.adminData = adminSheet ? adminSheet.getDataRange().getValues() : [];
    CACHE.lastCacheUpdate = new Date().getTime();
    
    Logger.log('Cache refreshed successfully');
  } catch (error) {
    Logger.log(`Error refreshing cache: ${error.message}`);
  }
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Admin ‡∏î‡πâ‡∏ß‡∏¢ Cache
 */
function checkAdminPermission(userId) {
  try {
    const adminData = getCachedData('adminData');
    if (!adminData || adminData.length <= 1) return false;
    
    const adminUserIds = adminData.slice(1).map(row => String(row[0]).trim());
    return adminUserIds.includes(String(userId).trim());
  } catch (e) {
    Logger.log(`Error checking admin permission: ${e.message}`);
    return false;
  }
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á Military ID ‡∏î‡πâ‡∏ß‡∏¢ Cache
 */
function getUserMilitaryId(userId) {
  try {
    const loginData = getCachedData('loginData');
    if (!loginData) return null;
    
    for (let i = 1; i < loginData.length; i++) {
      if (loginData[i][0] === userId) {
        return loginData[i][1];
      }
    }
    return null;
  } catch (error) {
    Logger.log(`Error getting military ID: ${error.message}`);
    return null;
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 */
function handleUserProfile(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
  
  try {
    const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
    const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
    
    const pData = personnelSheet.getDataRange().getValues();
    const cData = childSheet.getDataRange().getValues();
    
    let personnelInfo = null;
    let childrenCount = 0;
    
    // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•
    for (let i = 1; i < pData.length; i++) {
      if (String(pData[i][5]).trim() === String(militaryId).trim()) {
        personnelInfo = pData[i];
        break;
      }
    }
    
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏ï‡∏£
    for (let i = 1; i < cData.length; i++) {
      if (String(cData[i][0]).trim() === String(militaryId).trim()) {
        childrenCount++;
      }
    }
    
    if (!personnelInfo) {
      return sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
    }
    
    const profileFlex = createProfileFlexMessage(personnelInfo, childrenCount);
    sendFlex(userId, profileFlex);
    
  } catch (error) {
    Logger.log(`Error in handleUserProfile: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏π‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
 */
function handleUpcomingDuties(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
  
  try {
    const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
    const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
    
    // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£
    const name = getPersonnelName(militaryId);
    if (!name) return sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
    
    const today = new Date();
    const upcomingDuties = [];
    
    const dData = dutySheet.getDataRange().getValues();
    
    dData.slice(1).forEach(row => {
      if (row[2] === name) {
        const dutyDate = parseDateFromSheet(row[0]);
        if (dutyDate && dutyDate > today) {
          upcomingDuties.push({
            date: Utilities.formatDate(dutyDate, 'Asia/Bangkok', 'dd/MM/yyyy'),
            duty: row[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            company: row[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            sortDate: dutyDate
          });
        }
      }
    });
    
    upcomingDuties.sort((a, b) => a.sortDate - b.sortDate);
    
    if (upcomingDuties.length === 0) {
      return sendReply(userId, 'üìÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á');
    }
    
    const flex = createUpcomingDutiesFlexMessage(name, upcomingDuties.slice(0, 5));
    sendFlex(userId, flex);
    
  } catch (error) {
    Logger.log(`Error in handleUpcomingDuties: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•
 */
function handleSearchPersonnel(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  }
  
  const keyword = text.replace('/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ', '').trim().toLowerCase();
  if (!keyword) {
    return sendReply(userId, '‚ùó ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ‡∏™‡∏°‡∏ä‡∏≤‡∏¢');
  }
  
  try {
    const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
    const data = personnelSheet.getDataRange().getValues().slice(1);
    
    const results = data.filter(row => 
      `${row[1]} ${row[2]} ${row[3]} ${row[5]}`.toLowerCase().includes(keyword)
    );
    
    if (results.length === 0) {
      return sendReply(userId, `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö "${keyword}"`);
    }
    
    let message = `üîç ‡∏û‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ${results.length} ‡∏Ñ‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${keyword}"\n\n`;
    results.slice(0, MAX_SEARCH_RESULTS).forEach((person, index) => {
      message += `${index + 1}. ${person[1]} ${person[2]} ${person[3]}\n`;
      message += `   üÜî ${person[5]} | ${person[0]} | ${person[7]}\n\n`;
    });
    
    if (results.length > MAX_SEARCH_RESULTS) {
      message += `...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${results.length - MAX_SEARCH_RESULTS} ‡∏Ñ‡∏ô`;
    }
    
    sendReply(userId, message);
    
  } catch (error) {
    Logger.log(`Error in handleSearchPersonnel: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£
 */
function handleCreateDutySchedule(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£');
  }
  
  const parts = text.replace('/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ ', '').split('|');
  if (parts.length !== 3) {
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: /‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ <‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°(DD/MM/YYYY)>|<‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î(DD/MM/YYYY)>|<‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠(‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢,)>
    
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ 01/08/2568|31/08/2568|‡∏™‡∏°‡∏ä‡∏≤‡∏¢,‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á,‡∏™‡∏°‡∏®‡∏£‡∏µ`);
  }
  
  try {
    const [startDateStr, endDateStr, namesStr] = parts.map(p => p.trim());
    const startDate = parseThaiDateToDateObject(startDateStr);
    const endDate = parseThaiDateToDateObject(endDateStr);
    const names = namesStr.split(',').map(n => n.trim());
    
    if (!startDate || !endDate) {
      return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
    
    if (names.length === 0) {
      return sendReply(userId, '‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠');
    }
    
    const schedule = generateDutySchedule(startDate, endDate, names);
    const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
    
    schedule.forEach(duty => {
      dutySheet.appendRow([duty.date, duty.rank, duty.firstName, duty.lastName, duty.position, duty.company, duty.phone]);
    });
    
    sendReply(userId, `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${schedule.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    
  } catch (error) {
    Logger.log(`Error in handleCreateDutySchedule: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
 */
function handleMonthlyDutyReport(e) {
  const userId = e.source.userId;
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ');
  }
  
  try {
    const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
    const data = dutySheet.getDataRange().getValues().slice(1);
    
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    
    const monthlyDuties = data.filter(row => {
      const dutyDate = parseDateFromSheet(row[0]);
      return dutyDate && dutyDate.getMonth() + 1 === currentMonth && dutyDate.getFullYear() === currentYear;
    });
    
    // ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    const dutyStats = {};
    monthlyDuties.forEach(duty => {
      const name = `${duty[2]} ${duty[3]}`;
      dutyStats[name] = (dutyStats[name] || 0) + 1;
    });
    
    let report = `üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${currentMonth}/${currentYear}\n\n`;
    report += `üìã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${monthlyDuties.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n`;
    report += `üë• ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏ï‡∏≤‡∏°‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•:\n`;
    
    Object.entries(dutyStats)
      .sort((a, b) => b[1] - a[1])
      .forEach(([name, count], index) => {
        report += `${index + 1}. ${name}: ${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n`;
      });
    
    sendReply(userId, report);
    
  } catch (error) {
    Logger.log(`Error in handleMonthlyDutyReport: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
 */
function handleUsageStatistics(e) {
  const userId = e.source.userId;
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
  }
  
  try {
    const activitySheet = SpreadsheetApp.getActive().getSheetByName('‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    if (!activitySheet) {
      return sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    }
    
    const data = activitySheet.getDataRange().getValues().slice(1);
    const today = new Date().toDateString();
    
    const todayActivities = data.filter(row => new Date(row[1]).toDateString() === today);
    const totalUsers = new Set(data.map(row => row[0])).size;
    const activeToday = new Set(todayActivities.map(row => row[0])).size;
    
    // ‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢
    const commandStats = {};
    data.forEach(row => {
      const command = row[2].split(' ')[0];
      commandStats[command] = (commandStats[command] || 0) + 1;
    });
    
    let report = `üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n\n`;
    report += `üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalUsers} ‡∏Ñ‡∏ô\n`;
    report += `üü¢ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${activeToday} ‡∏Ñ‡∏ô\n`;
    report += `üìä ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${todayActivities.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n\n`;
    report += `üî• ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°:\n`;
    
    Object.entries(commandStats)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .forEach(([command, count], index) => {
        report += `${index + 1}. ${command}: ${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n`;
      });
    
    sendReply(userId, report);
    
  } catch (error) {
    Logger.log(`Error in handleUsageStatistics: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
 */
function handleNotificationSettings(userId, text) {
  const parts = text.replace('/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ', '').split('|');
  if (parts.length !== 2) {
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: /‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô <‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó>|<‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î>
    
‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:
- ‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
- ‡∏ö‡∏∏‡∏ï‡∏£: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£
- ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°|‡πÄ‡∏õ‡∏¥‡∏î`);
  }
  
  try {
    const [type, setting] = parts.map(p => p.trim());
    const settingsSheet = getOrCreateSheet('‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
    
    const validTypes = ['‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°', '‡∏ö‡∏∏‡∏ï‡∏£', '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á'];
    const validSettings = ['‡πÄ‡∏õ‡∏¥‡∏î', '‡∏õ‡∏¥‡∏î'];
    
    if (!validTypes.includes(type) || !validSettings.includes(setting)) {
      return sendReply(userId, '‚ùó ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    const data = settingsSheet.getDataRange().getValues();
    let found = false;
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === userId && data[i][1] === type) {
        settingsSheet.getRange(i + 1, 3).setValue(setting);
        found = true;
        break;
      }
    }
    
    if (!found) {
      settingsSheet.appendRow([userId, type, setting, new Date()]);
    }
    
    sendReply(userId, `‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "${type}" ‡πÄ‡∏õ‡πá‡∏ô "${setting}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    
  } catch (error) {
    Logger.log(`Error in handleNotificationSettings: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
 */
function handleSystemStatus(userId) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö');
  }
  
  try {
    const sheets = ['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤', '‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°', '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ', 'LOGIN', 'ADMIN'];
    let status = 'üñ•Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö\n\n';
    
    sheets.forEach(sheetName => {
      const sheet = SpreadsheetApp.getActive().getSheetByName(sheetName);
      if (sheet) {
        const rows = sheet.getLastRow() - 1; // ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö header
        status += `‚úÖ ${sheetName}: ${rows} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
      } else {
        status += `‚ùå ${sheetName}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó\n`;
      }
    });
    
    status += `\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ${Utilities.formatDate(new Date(), 'Asia/Bangkok', 'dd/MM/yyyy HH:mm:ss')}`;
    
    sendReply(userId, status);
    
  } catch (error) {
    Logger.log(`Error in handleSystemStatus: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
 */
function handleVersionInfo(userId) {
  const versionInfo = `
üì± LINE BOT ‡∏à‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á v2.0
üîß ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${Utilities.formatDate(new Date(), 'Asia/Bangkok', 'dd/MM/yyyy')}

üÜï ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà:
‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
‚Ä¢ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö Error Handling ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
‚Ä¢ Smart Help Message
‚Ä¢ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö Interactive

üîß ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á:
‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5 ‡πÄ‡∏ó‡πà‡∏≤
‚Ä¢ ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Quota ‡∏Ç‡∏≠‡∏á Google Sheets
‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Log ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
‚Ä¢ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á UI/UX ‡∏Ç‡∏≠‡∏á Flex Messages
‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î

üë®‚Äçüíª ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢: ‡∏ó‡∏µ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤ LINE BOT ‡∏à‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á
  `;
  
  sendReply(userId, versionInfo);
}

/**
 * Helper Functions
 */

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
 */
function getOrCreateSheet(sheetName) {
  let sheet = SpreadsheetApp.getActive().getSheetByName(sheetName);
  if (!sheet) {
    sheet = SpreadsheetApp.getActive().insertSheet(sheetName);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Header ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ä‡∏µ‡∏ó
    if (sheetName === '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô') {
      sheet.getRange(1, 1, 1, 4).setValues([['User ID', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç']]);
    } else if (sheetName === '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô') {
      sheet.getRange(1, 1, 1, 3).setValues([['User ID', '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á']]);
    }
  }
  return sheet;
}

/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
 */
function logUserActivity(userId, command) {
  try {
    const activitySheet = getOrCreateSheet('‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    activitySheet.appendRow([userId, new Date(), command]);
  } catch (error) {
    Logger.log(`Error logging activity: ${error.message}`);
  }
}

/**
 * ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Admin ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
 */
function notifyAdminError(error) {
  try {
    const adminData = getCachedData('adminData');
    if (adminData && adminData.length > 1) {
      const adminUserId = adminData[1][0]; // Admin ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
      sendReply(adminUserId, `‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:\n${error.message}\n\n‡πÄ‡∏ß‡∏•‡∏≤: ${new Date()}`);
    }
  } catch (e) {
    Logger.log(`Error notifying admin: ${e.message}`);
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£
 */
function getPersonnelName(militaryId) {
  try {
    const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
    const data = personnelSheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][5]).trim() === String(militaryId).trim()) {
        return data[i][2]; // ‡∏ä‡∏∑‡πà‡∏≠
      }
    }
    return null;
  } catch (error) {
    Logger.log(`Error getting personnel name: ${error.message}`);
    return null;
  }
}

/**
 * ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡πÄ‡∏õ‡πá‡∏ô Date Object
 */
function parseDateFromSheet(dateValue) {
  try {
    if (dateValue instanceof Date) {
      return dateValue;
    } else if (typeof dateValue === 'string') {
      const [day, month, year] = dateValue.split('/');
      const adYear = parseInt(year) > 2500 ? parseInt(year) - 543 : parseInt(year);
      return new Date(adYear, parseInt(month) - 1, parseInt(day));
    }
    return null;
  } catch (error) {
    Logger.log(`Error parsing date: ${error.message}`);
    return null;
  }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 */
function generateDutySchedule(startDate, endDate, names) {
  const schedule = [];
  const currentDate = new Date(startDate);
  let nameIndex = 0;
  
  while (currentDate <= endDate) {
    // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
    if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
      const name = names[nameIndex % names.length];
      const formattedDate = Utilities.formatDate(currentDate, 'Asia/Bangkok', 'dd/MM/yyyy');
      
      schedule.push({
        date: formattedDate,
        rank: '‡∏à.‡∏™.‡∏≠.', // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        firstName: name,
        lastName: '', // ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        position: '‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏ï‡∏π',
        company: '‡∏£.1',
        phone: '081-234-5678' // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      });
      
      nameIndex++;
    }
    
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  return schedule;
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
 */
function createProfileFlexMessage(personnelInfo, childrenCount) {
  return {
    type: "bubble",
    size: "giga",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",
          weight: "bold",
          color: "#ffffff",
          size: "lg",
          align: "center"
        }
      ],
      backgroundColor: "#2E7D32",
      paddingAll: "md"
    },
    body: {
      type: "box",
      layout: "vertical",
      spacing: "md",
      contents: [
        {
          type: "text",
          text: `${personnelInfo[1]} ${personnelInfo[2]} ${personnelInfo[3]}`,
          weight: "bold",
          size: "lg",
          align: "center",
          color: "#1976D2"
        },
        {
          type: "separator",
          margin: "md"
        },
        {
          type: "box",
          layout: "vertical",
          spacing: "sm",
          contents: [
            createInfoRow("üè¢", "‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢", personnelInfo[0]),
            createInfoRow("üéñÔ∏è", "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á", personnelInfo[7]),
            createInfoRow("üî∞", "‡πÄ‡∏´‡∏•‡πà‡∏≤", personnelInfo[8]),
            createInfoRow("üÜî", "‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£", personnelInfo[5]),
            createInfoRow("üë∂", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏ï‡∏£", `${childrenCount} ‡∏Ñ‡∏ô`),
            createInfoRow("‚è≥", "‡∏≠‡∏≤‡∏¢‡∏∏", `${personnelInfo[16]} ‡∏õ‡∏µ`),
            createInfoRow("üìÜ", "‡∏õ‡∏µ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì", personnelInfo[17])
          ]
        }
      ]
    },
    footer: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "button",
          action: {
            type: "message",
            label: "‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£",
            text: "/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô"
          },
          style: "primary",
          height: "sm"
        },
        {
          type: "button",
          action: {
            type: "message",
            label: "‡∏î‡∏π‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",
            text: "/‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô"
          },
          style: "secondary",
          height: "sm"
        }
      ],
      spacing: "sm"
    }
  };
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
 */
function createUpcomingDutiesFlexMessage(name, duties) {
  const dutyContents = duties.map(duty => ({
    type: "box",
    layout: "vertical",
    contents: [
      {
        type: "text",
        text: `üìÖ ${duty.date}`,
        weight: "bold",
        size: "sm",
        color: "#1976D2"
      },
      {
        type: "text",
        text: `üìç ${duty.duty}`,
        size: "xs",
        color: "#666666"
      },
      {
        type: "text",
        text: `üè¢ ${duty.company}`,
        size: "xs",
        color: "#666666"
      }
    ],
    margin: "sm",
    paddingAll: "md",
    backgroundColor: "#F5F5F5",
    cornerRadius: "8px"
  }));

  return {
    type: "bubble",
    size: "giga",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "‚è∞ ‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á",
          weight: "bold",
          color: "#ffffff",
          size: "md",
          align: "center"
        }
      ],
      backgroundColor: "#FF6F00",
      paddingAll: "md"
    },
    body: {
      type: "box",
      layout: "vertical",
      spacing: "md",
      contents: [
        {
          type: "text",
          text: `üë§ ${name}`,
          weight: "bold",
          size: "md",
          align: "center"
        },
        {
          type: "separator",
          margin: "md"
        },
        ...dutyContents
      ]
    }
  };
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Flex Message
 */
function createInfoRow(icon, label, value) {
  return {
    type: "box",
    layout: "horizontal",
    contents: [
      {
        type: "text",
        text: `${icon} ${label}`,
        size: "sm",
        color: "#666666",
        flex: 2
      },
      {
        type: "text",
        text: String(value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'),
        size: "sm",
        wrap: true,
        flex: 3,
        align: "end"
      }
    ]
  };
}

/**
 * ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ö‡∏ö Smart
 */
function getSmartHelpMessage(userInput) {
  const suggestions = {
    '‡πÄ‡∏ß‡∏£': '‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ /‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
    '‡∏ö‡∏∏‡∏ï‡∏£': '‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ /‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£',
    '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•': '‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ /‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå',
    '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á': '‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á',
    '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô': '‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ /‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
  };
  
  for (const [keyword, suggestion] of Object.entries(suggestions)) {
    if (userInput.toLowerCase().includes(keyword)) {
      return `üí° ${suggestion}\n\n‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå /‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`;
    }
  }
  
  return `‚ùì ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "${userInput}"\n\n‡∏û‡∏¥‡∏°‡∏û‡πå /‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏´‡∏£‡∏∑‡∏≠ /help ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠`;
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß
 */
function sendReply(userId, text) {
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    if (text.length > MAX_MESSAGE_LENGTH) {
      const chunks = text.match(new RegExp(`.{1,${MAX_MESSAGE_LENGTH}}`, 'g'));
      chunks.forEach((chunk, index) => {
        setTimeout(() => {
          UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", {
            method: "post",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + CHANNEL_ACCESS_TOKEN
            },
            payload: JSON.stringify({
              to: userId,
              messages: [{ 
                type: "text", 
                text: index === 0 ? chunk : `(‡∏ï‡πà‡∏≠ ${index + 1}) ${chunk}`
              }]
            })
          });
        }, index * 1000); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      });
    } else {
      UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", {
        method: "post",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + CHANNEL_ACCESS_TOKEN
        },
        payload: JSON.stringify({
          to: userId,
          messages: [{ type: "text", text }]
        })
      });
    }
  } catch (error) {
    Logger.log(`Error sending reply: ${error.message}`);
  }
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á Flex Message
 */
function sendFlex(userId, flexContent) {
  try {
    UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", {
      method: "post",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + CHANNEL_ACCESS_TOKEN
      },
      payload: JSON.stringify({
        to: userId,
        messages: [
          {
            type: "flex",
            altText: "üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
            contents: flexContent
          }
        ]
      })
    });
  } catch (error) {
    Logger.log(`Error sending flex message: ${error.message}`);
  }
}

/**
 * ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß
 */
function getHelpMessage() {
  return `ü§ñ **‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏´‡∏≤‡∏£ LINE Bot v2.0**

üìã **‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô**
‚Ä¢ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô <‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£>

üë§ **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß**
‚Ä¢ /‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
‚Ä¢ /‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
‚Ä¢ /‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á

‚è∞ **‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°**
‚Ä¢ /‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - ‡∏î‡∏π‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
‚Ä¢ /‡πÄ‡∏ß‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ - ‡∏î‡∏π‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
‚Ä¢ /‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏î‡∏π‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
‚Ä¢ /‡πÄ‡∏ß‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á - ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏£

üë∂ **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£**
‚Ä¢ /‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î>
‚Ä¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏ï‡∏£ <‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°>|<‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡∏°‡πà>
‚Ä¢ /‡∏•‡∏ö‡∏ö‡∏∏‡∏ï‡∏£ <‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•>
‚Ä¢ /‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

üë• **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•** (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î>
‚Ä¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î>
‚Ä¢ /‡∏•‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£>
‚Ä¢ /‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
‚Ä¢ /‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î>

üõ°Ô∏è **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°** (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£ <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î>
‚Ä¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏£ <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î>
‚Ä¢ /‡∏•‡∏ö‡πÄ‡∏ß‡∏£ <‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà>|<‡∏ä‡∏∑‡πà‡∏≠>
‚Ä¢ /‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
‚Ä¢ /‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ <‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°>|<‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î>|<‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠>

üìú **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á**
‚Ä¢ /‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î> (‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î> (‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î> (‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î>

üìä **‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥** (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢
‚Ä¢ /‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
‚Ä¢ /‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
‚Ä¢ /‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

üîß **‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤**
‚Ä¢ /‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô <‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó>|<‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î>
‚Ä¢ /‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô

üñ•Ô∏è **‡∏£‡∏∞‡∏ö‡∏ö** (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
‚Ä¢ /‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô

üí° **‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏±‡∏î**
‚Ä¢ /help ‡∏´‡∏£‡∏∑‡∏≠ /‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ

üî• **‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà v2.0:**
- ‡∏£‡∏∞‡∏ö‡∏ö Cache ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß 5 ‡πÄ‡∏ó‡πà‡∏≤
- Smart Help ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå
- ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Real-time
- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á

‚ö° **‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:** ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "‡πÄ‡∏ß‡∏£", "‡∏ö‡∏∏‡∏ï‡∏£", "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°!`;
}

// ====================================================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
// ====================================================================

/**
 * ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
 */
function handleRegistration(userId, text) {
  try {
    const parts = text.split(' ');
    if (parts.length !== 2 || parts[0] !== '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô') {
      return sendReply(userId, '‚ùó ‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô <‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£>\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô 1565601540');
    }

    const militaryId = parts[1];
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£ (10 ‡∏´‡∏•‡∏±‡∏Å)
    if (!/^\d{10}$/.test(militaryId)) {
      return sendReply(userId, '‚ùó ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å');
    }

    const loginSheet = SpreadsheetApp.getActive().getSheetByName('LOGIN');
    const loginData = loginSheet.getDataRange().getValues();
    
    const existingUser = loginData.find(row => row[0] === userId);
    const alreadyUsed = loginData.find(row => row[1] === militaryId && row[0] !== userId);

    if (alreadyUsed) {
      return sendReply(userId, '‚ùå ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
    }

    if (existingUser) {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
      const rowIndex = loginData.findIndex(row => row[0] === userId);
      loginSheet.getRange(rowIndex + 1, 2).setValue(militaryId);
      refreshCache(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Cache
      return sendReply(userId, '‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    } else {
      // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
      loginSheet.appendRow([userId, militaryId, new Date()]);
      refreshCache(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Cache
      return sendReply(userId, `‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£: ${militaryId}\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß\n\n‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå /‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`);
    }
    
  } catch (error) {
    Logger.log(`Error in handleRegistration: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
  }
}

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
 */
function handleAddChild(userId, text) {
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  try {
    const parts = text.replace('/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ ', '').split('|');
    if (parts.length !== 7) {
      return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      
üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ <‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•>|<‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î(DD/MM/YYYY)>|<‡∏≠‡∏≤‡∏¢‡∏∏>|<‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤>|<‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô>|<‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤>|<‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô>

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ|01/01/2010|14|‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô|‡∏°.2|‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà|3.25`);
    }

    const [name, birthdate, age, educationLevel, grade, school, result] = parts.map(p => p.trim());

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
    if (!parseThaiDateToDateObject(birthdate)) {
      return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ DD/MM/YYYY');
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏
    if (!/^\d+$/.test(age) || parseInt(age) < 0 || parseInt(age) > 30) {
      return sendReply(userId, '‚ùó ‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0-30 ‡∏õ‡∏µ');
    }

    const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const existingData = childSheet.getDataRange().getValues();
    const duplicate = existingData.find((row, index) => 
      index > 0 && row[0] == militaryId && row[1] === name
    );
    
    if (duplicate) {
      return sendReply(userId, `‚ùå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ä‡∏∑‡πà‡∏≠ "${name}" ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);
    }

    childSheet.appendRow([militaryId, name, birthdate, age, educationLevel, grade, school, result, new Date()]);
    
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° Flex Message
    sendReply(userId, `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£ "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    
    // ‡∏™‡πà‡∏á Flex Message ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°
    setTimeout(() => {
      sendFlexChildInfo(userId, name, age, school, grade, result);
    }, 1000);
    
  } catch (error) {
    Logger.log(`Error in handleAddChild: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£');
  }
}

/**
 * ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY (‡∏û.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ.‡∏®.) ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ Date (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
 */
function parseThaiDateToDateObject(dateString) {
  try {
    if (!dateString || typeof dateString !== 'string') return null;
    
    const parts = dateString.trim().split('/');
    if (parts.length !== 3) return null;

    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    let year = parseInt(parts[2], 10);

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
    if (day < 1 || day > 31 || month < 1 || month > 12) return null;

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
    if (year > 2500) {
      year -= 543;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
    if (year < 1900 || year > 2100) return null;

    const date = new Date(year, month - 1, day);

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    if (date.getDate() !== day || date.getMonth() + 1 !== month || date.getFullYear() !== year) {
      return null;
    }
    
    return date;
  } catch (error) {
    Logger.log(`Error parsing date: ${error.message}`);
    return null;
  }
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°
 */
function handleCommandDutyToday(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  try {
    const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
    const name = getPersonnelName(militaryId);
    
    if (!name) return sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');

    const today = Utilities.formatDate(new Date(), 'Asia/Bangkok', 'dd/MM/yyyy');
    const ddata = dutySheet.getDataRange().getValues();
    let foundDuty = false;

    for (let i = 1; i < ddata.length; i++) {
      const row = ddata[i];
      if (!row[0] || !row[2]) continue;

      let dutyDateStr = '';
      if (row[0] instanceof Date) {
        dutyDateStr = Utilities.formatDate(row[0], 'Asia/Bangkok', 'dd/MM/yyyy');
      } else {
        dutyDateStr = row[0].toString();
      }

      if (dutyDateStr === today && row[2] === name) {
        const rank = row[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏®';
        const firstName = row[2] || '';
        const lastName = row[3] || '';
        const duty = row[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
        const company = row[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢';
        const phone = row[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£';

        const fullName = `${rank} ${firstName} ${lastName}`;
        sendFlexDutyReminder(userId, fullName, duty, company, phone);
        foundDuty = true;
        break;
      }
    }

    if (!foundDuty) {
      sendReply(userId, '‚úÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°\n\n‡∏•‡∏≠‡∏á‡∏î‡∏π‡πÄ‡∏ß‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ /‡πÄ‡∏ß‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ');
    }
    
  } catch (error) {
    Logger.log(`Error in handleCommandDutyToday: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£');
  }
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•
 */
function handleCommandPersonnelInfo(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  try {
    const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
    const pData = personnelSheet.getDataRange().getValues();

    for (let i = 1; i < pData.length; i++) {
      if (String(pData[i][5]).trim() === String(militaryId).trim()) {
        const data = pData[i];
        const imageUrl = data[17] || 'https://via.placeholder.com/150x150/4CAF50/white?text=No+Image';
        
        const flex = {
          type: "bubble",
          size: "giga",
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "image",
                url: imageUrl,
                size: "full",
                aspectMode: "cover",
                aspectRatio: "1:1",
                gravity: "center"
              },
              {
                type: "box",
                layout: "vertical",
                spacing: "sm",
                paddingAll: "lg",
                contents: [
                  {
                    type: "text",
                    text: "ü™ñ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•",
                    weight: "bold",
                    color: "#1DB446",
                    size: "lg",
                    align: "center"
                  },
                  {
                    type: "separator",
                    margin: "md"
                  },
                  {
                    type: "text",
                    text: `${data[1] || ''} ${data[2] || ''} ${data[3] || ''}`,
                    weight: "bold",
                    size: "lg",
                    align: "center",
                    margin: "md"
                  },
                  {
                    type: "box",
                    layout: "vertical",
                    margin: "md",
                    spacing: "xs",
                    contents: [
                      { type: "text", text: `üìå ‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢ : ${data[0] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üÜî ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ‡∏õ‡∏ä‡∏ä. : ${data[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `ü™ñ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£ : ${data[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üìç ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î : ${data[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üéñÔ∏è ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á : ${data[7] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üî∞ ‡πÄ‡∏´‡∏•‡πà‡∏≤ : ${data[8] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üè† ‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î : ${data[9] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üéÇ ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î : ${data[10] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `‚è≥ ‡∏≠‡∏≤‡∏¢‡∏∏ : ${data[11] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏õ‡∏µ`, size: "sm", wrap: true },
                      { type: "text", text: `üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô : ${data[12] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏à‡∏∏ : ${data[13] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏á‡∏¢‡∏® : ${data[14] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô : ${data[15] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true },
                      { type: "text", text: `üìÜ ‡∏õ‡∏µ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì : ${data[16] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`, size: "sm", wrap: true }
                    ]
                  }
                ]
              }
            ]
          },
          styles: {
            body: {
              separator: true
            }
          }
        };
        
        sendFlex(userId, flex);
        return;
      }
    }
    
    sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
    
  } catch (error) {
    Logger.log(`Error in handleCommandPersonnelInfo: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  }
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£
 */
function handleCommandChildInfo(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  try {
    const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
    const children = childSheet.getDataRange().getValues()
      .slice(1)
      .filter(row => row[0] == militaryId);

    if (children.length === 0) {
      return sendReply(userId, `üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ

üí° ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ <‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•>|<‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î>|<‡∏≠‡∏≤‡∏¢‡∏∏>|<‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤>|<‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô>|<‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤>|<‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô>`);
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ
    sendReply(userId, `üë∂ **‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£ ${children.length} ‡∏Ñ‡∏ô**\n\n‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô...`);

    // ‡∏™‡πà‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
    children.forEach((child, index) => {
      setTimeout(() => {
        sendFlexChildInfo(userId, child[1], child[3], child[6], child[5], child[7]);
      }, (index + 1) * 1500); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    });
    
  } catch (error) {
    Logger.log(`Error in handleCommandChildInfo: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£');
  }
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á Flex Message ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£
 */
function sendFlexChildInfo(userId, name, age, school, grade, result) {
  const flex = {
    type: "bubble",
    size: "giga",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "üë∂ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£",
          weight: "bold",
          color: "#ffffff",
          size: "lg",
          align: "center"
        }
      ],
      backgroundColor: "#E91E63",
      paddingAll: "md"
    },
    body: {
      type: "box",
      layout: "vertical",
      spacing: "md",
      paddingAll: "lg",
      contents: [
        {
          type: "text",
          text: name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
          weight: "bold",
          size: "lg",
          align: "center",
          color: "#1976D2"
        },
        {
          type: "separator",
          margin: "md"
        },
        {
          type: "box",
          layout: "vertical",
          spacing: "sm",
          contents: [
            createInfoRow("üéÇ", "‡∏≠‡∏≤‡∏¢‡∏∏", `${age || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏õ‡∏µ`),
            createInfoRow("üéì", "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô", grade || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'),
            createInfoRow("üè´", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤", school || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'),
            createInfoRow("üìä", "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", result || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')
          ]
        }
      ]
    },
    footer: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏ï‡∏£",
          size: "xs",
          color: "#666666",
          align: "center"
        }
      ],
      paddingTop: "sm"
    }
  };
  
  sendFlex(userId, flex);
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á Flex Message ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°
 */
function sendFlexDutyReminder(userId, fullName, duty, company, phone) {
  const flex = {
    type: "bubble",
    size: "giga",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "‚è∞ ‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
          weight: "bold",
          color: "#ffffff",
          size: "lg",
          align: "center"
        },
        {
          type: "text",
          text: Utilities.formatDate(new Date(), 'Asia/Bangkok', 'dd/MM/yyyy'),
          color: "#ffffff",
          size: "sm",
          align: "center"
        }
      ],
      backgroundColor: "#FF5722",
      paddingAll: "md"
    },
    body: {
      type: "box",
      layout: "vertical",
      spacing: "md",
      paddingAll: "lg",
      contents: [
        {
          type: "text",
          text: fullName,
          weight: "bold",
          size: "lg",
          align: "center",
          color: "#1976D2"
        },
        {
          type: "separator",
          margin: "md"
        },
        {
          type: "box",
          layout: "vertical",
          spacing: "sm",
          contents: [
            createInfoRow("üõ°Ô∏è", "‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà", duty),
            createInfoRow("üè¢", "‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢", company),
            createInfoRow("üìû", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", phone)
          ]
        }
      ]
    },
    footer: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
          size: "xs",
          color: "#666666",
          align: "center"
        }
      ],
      paddingTop: "sm"
    }
  };
  
  sendFlex(userId, flex);
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢
 */
function handleCompanyChildrenReport(e) {
  const userId = e.source.userId;
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ');
  }

  try {
    const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
    const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');

    if (!childSheet || !personnelSheet) {
      return sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
    }

    const childData = childSheet.getDataRange().getValues();
    const personnelData = personnelSheet.getDataRange().getValues();

    if (childData.length <= 1 && personnelData.length <= 1) {
      return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
    }

    const children = childData.slice(1);
    const personnel = personnelData.slice(1);

    // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£
    const childrenByMilitaryId = {};
    children.forEach(child => {
      if (child[0]) {
        const militaryId = String(child[0]).trim();
        if (!childrenByMilitaryId[militaryId]) {
          childrenByMilitaryId[militaryId] = [];
        }
        childrenByMilitaryId[militaryId].push(child);
      }
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    let report = 'üìä **‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢**\n';
    report += `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${Utilities.formatDate(new Date(), 'Asia/Bangkok', 'dd/MM/yyyy HH:mm')}\n\n`;
    
    let totalChildren = 0;
    let schoolAgeChildren = 0;
    let personnelWithChildren = 0;

    personnel.forEach(person => {
      if (person[5]) {
        const militaryId = String(person[5]).trim();
        const rank = person[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏®';
        const firstName = person[2] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
        const lastName = person[3] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏Å‡∏∏‡∏•';
        const company = person[0] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢';

        const childrenOfThisPersonnel = childrenByMilitaryId[militaryId] || [];

        if (childrenOfThisPersonnel.length > 0) {
          personnelWithChildren++;
          report += `**${rank} ${firstName} ${lastName} (${company})**\n`;
          
          childrenOfThisPersonnel.forEach((child, index) => {
            const childName = child[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
            const childAge = parseInt(child[3], 10) || 0;
            const childEducationLevel = child[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            const childSchool = child[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

            report += `  ${index + 1}. ${childName} (‡∏≠‡∏≤‡∏¢‡∏∏ ${childAge} ‡∏õ‡∏µ)\n`;
            report += `     ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${childEducationLevel}, ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${childSchool}\n`;

            totalChildren++;
            if (childAge >= 6 && childAge <= 18) {
              schoolAgeChildren++;
            }
          });
          report += '\n';
        }
      }
    });

    // ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    report += `---\n**üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:**\n`;
    report += `üë• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ö‡∏∏‡∏ï‡∏£: ${personnelWithChildren} ‡∏Ñ‡∏ô\n`;
    report += `üë∂ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalChildren} ‡∏Ñ‡∏ô\n`;
    report += `üéì ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡∏ß‡∏±‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (6-18 ‡∏õ‡∏µ): ${schoolAgeChildren} ‡∏Ñ‡∏ô\n`;
    report += `üìä ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ö‡∏∏‡∏ï‡∏£‡∏ß‡∏±‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${totalChildren > 0 ? Math.round((schoolAgeChildren/totalChildren)*100) : 0}%`;

    sendReply(userId, report);
    
  } catch (error) {
    Logger.log(`Error in handleCompanyChildrenReport: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
  }
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
 */
function sendDailyDutyReminder() {
  try {
    const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
    const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
    const settingsSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
    
    const ddata = dutySheet.getDataRange().getValues();
    const pdata = personnelSheet.getDataRange().getValues();
    const today = Utilities.formatDate(new Date(), 'Asia/Bangkok', 'dd/MM/yyyy');

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á militaryId ‡∏Å‡∏±‡∏ö userId
    const loginData = getCachedData('loginData');
    const militaryIdToUserId = {};
    
    if (loginData) {
      loginData.slice(1).forEach(row => {
        militaryIdToUserId[row[1]] = row[0];
      });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const notificationSettings = {};
    if (settingsSheet) {
      const settingsData = settingsSheet.getDataRange().getValues();
      settingsData.slice(1).forEach(row => {
        if (row[1] === '‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°' && row[2] === '‡πÄ‡∏õ‡∏¥‡∏î') {
          notificationSettings[row[0]] = true;
        }
      });
    }

    let notificationsSent = 0;

    ddata.slice(1).forEach(row => {
      if (row[0] && row[2]) {
        let dutyDateStr = '';
        if (row[0] instanceof Date) {
          dutyDateStr = Utilities.formatDate(row[0], 'Asia/Bangkok', 'dd/MM/yyyy');
        } else {
          dutyDateStr = row[0].toString();
        }

        if (dutyDateStr === today) {
          const firstName = row[2];
          const lastName = row[3];

          // ‡∏´‡∏≤ militaryId ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
          let militaryIdFound = null;
          for (let i = 1; i < pdata.length; i++) {
            if (pdata[i][2] === firstName && pdata[i][3] === lastName) {
              militaryIdFound = pdata[i][5];
              break;
            }
          }

          if (militaryIdFound && militaryIdToUserId[militaryIdFound]) {
            const targetUserId = militaryIdToUserId[militaryIdFound];
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)
            if (!settingsSheet || !notificationSettings.hasOwnProperty(targetUserId) || notificationSettings[targetUserId]) {
              const rank = row[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏®';
              const duty = row[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
              const company = row[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢';
              const phone = row[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£';
              const fullName = `${rank} ${firstName} ${lastName}`;
              
              sendFlexDutyReminder(targetUserId, fullName, duty, company, phone);
              notificationsSent++;
            }
          } else {
            Logger.log(`‡πÑ‡∏°‡πà‡∏û‡∏ö LINE User ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${firstName} ${lastName} (‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£: ${militaryIdFound})`);
          }
        }
      }
    });

    Logger.log(`‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${notificationsSent} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    
  } catch (error) {
    Logger.log(`Error in sendDailyDutyReminder: ${error.message}`);
    notifyAdminError(error);
  }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
 */
function createDailyDutyReminderTrigger() {
  try {
    // ‡∏•‡∏ö Trigger ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'sendDailyDutyReminder') {
        ScriptApp.deleteTrigger(trigger);
      }
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡πÉ‡∏´‡∏°‡πà
    ScriptApp.newTrigger('sendDailyDutyReminder')
      .timeBased()
      .everyDays(1)
      .atHour(7)
      .nearMinute(30)
      .inTimezone('Asia/Bangkok')
      .create();

    Logger.log('Daily duty reminder trigger created successfully at 07:30 Asia/Bangkok');
    
  } catch (error) {
    Logger.log(`Error creating trigger: ${error.message}`);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
 */
function handleTestNotification(userId) {
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  try {
    const name = getPersonnelName(militaryId);
    if (!name) return sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');

    // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    sendFlexDutyReminder(
      userId, 
      `‡∏à.‡∏™.‡∏≠. ${name}`, 
      '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö', 
      '‡∏£.‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 
      '081-234-5678'
    );
    
    setTimeout(() => {
      sendReply(userId, '‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n\nüí° ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÉ‡∏ä‡πâ:\n/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°|‡∏õ‡∏¥‡∏î');
    }, 2000);
    
  } catch (error) {
    Logger.log(`Error in handleTestNotification: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
  }
}

// ====================================================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö
// ====================================================================

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin Only)
 */
function createDataBackup() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const backupName = `Backup_${Utilities.formatDate(new Date(), 'Asia/Bangkok', 'yyyyMMdd_HHmmss')}`;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÑ‡∏ü‡∏•‡πå
    DriveApp.getFileById(ss.getId()).makeCopy(backupName);
    
    Logger.log(`Backup created: ${backupName}`);
    return backupName;
    
  } catch (error) {
    Logger.log(`Error creating backup: ${error.message}`);
    return null;
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (Admin Only)
 */
function cleanOldData() {
  try {
    const activitySheet = SpreadsheetApp.getActive().getSheetByName('‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    if (!activitySheet) return;
    
    const data = activitySheet.getDataRange().getValues();
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - 30); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 30 ‡∏ß‡∏±‡∏ô
    
    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 30 ‡∏ß‡∏±‡∏ô
    for (let i = data.length - 1; i >= 1; i--) {
      const recordDate = new Date(data[i][1]);
      if (recordDate < cutoffDate) {
        activitySheet.deleteRow(i + 1);
      }
    }
    
    Logger.log('Old activity data cleaned successfully');
    
  } catch (error) {
    Logger.log(`Error cleaning old data: ${error.message}`);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏ö
 */
function performSystemHealthCheck() {
  const healthReport = {
    timestamp: new Date(),
    sheets: {},
    triggers: {},
    cache: {},
    errors: []
  };
  
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏µ‡∏ó
    const requiredSheets = ['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤', '‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°', '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ', 'LOGIN', 'ADMIN'];
    
    requiredSheets.forEach(sheetName => {
      const sheet = SpreadsheetApp.getActive().getSheetByName(sheetName);
      if (sheet) {
        healthReport.sheets[sheetName] = {
          exists: true,
          rows: sheet.getLastRow(),
          columns: sheet.getLastColumn()
        };
      } else {
        healthReport.sheets[sheetName] = { exists: false };
        healthReport.errors.push(`Missing sheet: ${sheetName}`);
      }
    });
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Triggers
    const triggers = ScriptApp.getProjectTriggers();
    healthReport.triggers.count = triggers.length;
    healthReport.triggers.daily_reminder = triggers.some(t => t.getHandlerFunction() === 'sendDailyDutyReminder');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Cache
    healthReport.cache.last_update = CACHE.lastCacheUpdate;
    healthReport.cache.has_login_data = CACHE.loginData !== null;
    healthReport.cache.has_admin_data = CACHE.adminData !== null;
    
    Logger.log('System health check completed:', JSON.stringify(healthReport, null, 2));
    return healthReport;
    
  } catch (error) {
    healthReport.errors.push(`Health check error: ${error.message}`);
    Logger.log('System health check failed:', error.message);
    return healthReport;
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö
 */
function handleAdminSystemControl(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö');
  }
  
  const command = text.toLowerCase();
  
  try {
    if (command === '/admin backup') {
      const backupName = createDataBackup();
      if (backupName) {
        sendReply(userId, `‚úÖ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: ${backupName}`);
      } else {
        sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      }
      
    } else if (command === '/admin cleanup') {
      cleanOldData();
      sendReply(userId, '‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      
    } else if (command === '/admin health') {
      const healthReport = performSystemHealthCheck();
      let message = `üè• **‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏ö**\n\n`;
      
      // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏µ‡∏ó
      message += `üìã **‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:**\n`;
      Object.entries(healthReport.sheets).forEach(([name, status]) => {
        message += `${status.exists ? '‚úÖ' : '‚ùå'} ${name}`;
        if (status.exists) {
          message += ` (${status.rows} ‡πÅ‡∏ñ‡∏ß)`;
        }
        message += `\n`;
      });
      
      // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Triggers
      message += `\n‚è∞ **Triggers:** ${healthReport.triggers.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
      message += `üìÖ Daily Reminder: ${healthReport.triggers.daily_reminder ? '‚úÖ' : '‚ùå'}\n`;
      
      // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Cache
      message += `\nüíæ **Cache:**\n`;
      message += `Login Data: ${healthReport.cache.has_login_data ? '‚úÖ' : '‚ùå'}\n`;
      message += `Admin Data: ${healthReport.cache.has_admin_data ? '‚úÖ' : '‚ùå'}\n`;
      
      // ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
      if (healthReport.errors.length > 0) {
        message += `\n‚ö†Ô∏è **‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:**\n`;
        healthReport.errors.forEach(error => {
          message += `‚Ä¢ ${error}\n`;
        });
      }
      
      message += `\nüïê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${Utilities.formatDate(healthReport.timestamp, 'Asia/Bangkok', 'dd/MM/yyyy HH:mm:ss')}`;
      
      sendReply(userId, message);
      
    } else if (command === '/admin cache refresh') {
      refreshCache();
      sendReply(userId, '‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Cache ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      
    } else {
      sendReply(userId, `üîß **‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Admin:**
      
/admin backup - ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
/admin cleanup - ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
/admin health - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏ö
/admin cache refresh - ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Cache`);
    }
    
  } catch (error) {
    Logger.log(`Error in handleAdminSystemControl: ${error.message}`);
    sendReply(userId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Webhook Verification (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE Bot)
 */
function doGet(e) {
  return HtmlService.createHtmlOutput('LINE Bot ‡∏à‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á v2.0 is running!');
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á)
 */
function initializeSystem() {
  try {
    Logger.log('Initializing system...');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ó‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    const requiredSheets = [
      { name: 'LOGIN', headers: ['User ID', 'Military ID', 'Registration Date'] },
      { name: 'ADMIN', headers: ['User ID', 'Role', 'Added Date'] },
      { name: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', headers: ['User ID', 'Timestamp', 'Command'] },
      { name: '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', headers: ['User ID', 'Type', 'Status', 'Updated Date'] }
    ];
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    requiredSheets.forEach(sheetConfig => {
      let sheet = ss.getSheetByName(sheetConfig.name);
      if (!sheet) {
        sheet = ss.insertSheet(sheetConfig.name);
        sheet.getRange(1, 1, 1, sheetConfig.headers.length).setValues([sheetConfig.headers]);
        sheet.getRange(1, 1, 1, sheetConfig.headers.length).setFontWeight('bold');
        Logger.log(`Created sheet: ${sheetConfig.name}`);
      }
    });
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger
    createDailyDutyReminderTrigger();
    
    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Cache
    refreshCache();
    
    Logger.log('System initialization completed successfully');
    
  } catch (error) {
    Logger.log(`Error initializing system: ${error.message}`);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 */
function exportDataToCSV(sheetName) {
  try {
    const sheet = SpreadsheetApp.getActive().getSheetByName(sheetName);
    if (!sheet) return null;
    
    const data = sheet.getDataRange().getValues();
    let csv = '';
    
    data.forEach(row => {
      csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
    });
    
    const blob = Utilities.newBlob(csv, 'text/csv', `${sheetName}_${Utilities.formatDate(new Date(), 'Asia/Bangkok', 'yyyyMMdd')}.csv`);
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Google Drive
    const file = DriveApp.createFile(blob);
    
    return file.getUrl();
    
  } catch (error) {
    Logger.log(`Error exporting data: ${error.message}`);
    return null;
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 */
function importDataFromCSV(fileId, sheetName) {
  try {
    const file = DriveApp.getFileById(fileId);
    const csvContent = file.getBlob().getDataAsString();
    const rows = csvContent.split('\n').map(row => 
      row.split(',').map(cell => cell.replace(/^"|"$/g, '').replace(/""/g, '"'))
    );
    
    const sheet = SpreadsheetApp.getActive().getSheetByName(sheetName);
    if (!sheet) return false;
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô header)
    if (sheet.getLastRow() > 1) {
      sheet.deleteRows(2, sheet.getLastRow() - 1);
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    if (rows.length > 1) {
      sheet.getRange(2, 1, rows.length - 1, rows[0].length).setValues(rows.slice(1));
    }
    
    return true;
    
  } catch (error) {
    Logger.log(`Error importing data: ${error.message}`);
    return false;
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Monitoring ‡πÅ‡∏•‡∏∞ Alerting
 */
function setupMonitoring() {
  try {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏∏‡∏Å 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
    ScriptApp.newTrigger('performSystemHealthCheck')
      .timeBased()
      .everyHours(6)
      .create();
      
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
    ScriptApp.newTrigger('cleanOldData')
      .timeBased()
      .everyWeeks(1)
      .onWeekDay(ScriptApp.WeekDay.SUNDAY)
      .atHour(2)
      .create();
      
    Logger.log('Monitoring triggers created successfully');
    
  } catch (error) {
    Logger.log(`Error setting up monitoring: ${error.message}`);
  }
}

// ====================================================================
// Utility Functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
// ====================================================================

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 */
function validatePersonnelData(data) {
  const required = ['‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢', '‡∏¢‡∏®', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏™‡∏Å‡∏∏‡∏•', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£'];
  const errors = [];
  
  required.forEach((field, index) => {
    if (!data[index] || String(data[index]).trim() === '') {
      errors.push(`${field}‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏`);
    }
  });
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)
  if (data[4] && !/^\d{13}$/.test(String(data[4]).replace(/-/g, ''))) {
    errors.push('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£ (10 ‡∏´‡∏•‡∏±‡∏Å)
  if (data[5] && !/^\d{10}$/.test(String(data[5]))) {
    errors.push('‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }
  
  return errors;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£
 */
function validateChildData(data) {
  const errors = [];
  
  if (!data[0] || String(data[0]).trim() === '') {
    errors.push('‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏');
  }
  
  if (!data[1] || !parseThaiDateToDateObject(data[1])) {
    errors.push('‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }
  
  if (!data[2] || !/^\d+$/.test(data[2]) || parseInt(data[2]) < 0 || parseInt(data[2]) > 30) {
    errors.push('‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }
  
  return errors;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Sanitize ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 */
function sanitizeInput(input) {
  if (typeof input !== 'string') return input;
  
  return input
    .trim()
    .replace(/[<>]/g, '') // ‡∏•‡∏ö HTML tags
    .replace(/[^\u0E00-\u0E7F\w\s\-\.\(\)\/]/g, '') // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡πÑ‡∏ó‡∏¢ ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    .substring(0, 200); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Format ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
 */
function formatMessage(message, maxLength = MAX_MESSAGE_LENGTH) {
  if (!message) return '';
  
  let formatted = String(message).trim();
  
  if (formatted.length > maxLength) {
    formatted = formatted.substring(0, maxLength - 3) + '...';
  }
  
  return formatted;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Rate Limiting
 */
const RATE_LIMIT = {
  requests: {},
  limit: 10, // 10 requests per minute
  window: 60000 // 1 minute
};

function checkRateLimit(userId) {
  const now = Date.now();
  const userRequests = RATE_LIMIT.requests[userId] || [];
  
  // ‡∏•‡∏ö requests ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô window
  const validRequests = userRequests.filter(time => now - time < RATE_LIMIT.window);
  
  if (validRequests.length >= RATE_LIMIT.limit) {
    return false; // ‡πÄ‡∏Å‡∏¥‡∏ô rate limit
  }
  
  validRequests.push(now);
  RATE_LIMIT.requests[userId] = validRequests;
  
  return true;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Session
 */
const USER_SESSIONS = {};

function createUserSession(userId, data = {}) {
  USER_SESSIONS[userId] = {
    ...data,
    created: new Date(),
    lastActivity: new Date()
  };
}

function getUserSession(userId) {
  const session = USER_SESSIONS[userId];
  if (session) {
    session.lastActivity = new Date();
    return session;
  }
  return null;
}

function clearUserSession(userId) {
  delete USER_SESSIONS[userId];
}

// ====================================================================
// Constants ‡πÅ‡∏•‡∏∞ Configuration
// ====================================================================

const BOT_CONFIG = {
  VERSION: '2.0',
  AUTHOR: '‡∏ó‡∏µ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤ LINE BOT ‡∏à‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á',
  LAST_UPDATE: '2024-07-29',
  FEATURES: [
    '‡∏£‡∏∞‡∏ö‡∏ö Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û',
    '‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Real-time',
    '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
    '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
    '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á',
    '‡∏£‡∏∞‡∏ö‡∏ö Error Handling ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô',
    'Smart Help Message',
    '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö Interactive',
    '‡∏£‡∏∞‡∏ö‡∏ö Rate Limiting',
    '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Session',
    'Data Validation',
    'System Monitoring',
    'Auto Backup',
    'Export/Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
  ]
};

// Export functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    doPost,
    doGet,
    initializeSystem,
    createDailyDutyReminderTrigger,
    sendDailyDutyReminder,
    performSystemHealthCheck,
    createDataBackup,
    cleanOldData
  };
}

// ====================================================================
// ‡∏à‡∏ö‡πÑ‡∏ü‡∏•‡πå - LINE BOT ‡∏à‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á v2.0
// ====================================================================
