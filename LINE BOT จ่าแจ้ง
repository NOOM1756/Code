const CHANNEL_ACCESS_TOKEN = 'eCaIGNhvRTfGaVBxW9pAp2P5WSK7QGoB7/xePOUoJrgYoggex9Iz7nGqjpevJC/281jaC9xW4SFq75b+5CEvVsl/07NXXecUYG/tGeVvEuj0yPp0Np00wRTNU/OVYoQCH/ib4lFqvAt8pp6tqJOBxAdB04t89/1O/w1cDnyilFU=';

function doPost(e) {
  const event = JSON.parse(e.postData.contents).events[0];
  const userId = event.source.userId;
  const text = event.message.text.trim();

  // ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
  if (text.startsWith('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô')) handleRegistration(userId, text);

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
  else if (text === '/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô') handleCommandChildInfo(event);
  else if (text === '/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô') handleCommandPersonnelInfo(event);

  // ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°
  else if (text === '/‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô') handleCommandDutyToday(event);
  else if (text === '/‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô') handleMonthlyDuty(event);
  else if (text === '/‡πÄ‡∏ß‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á') handlePastDuties(event);

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• (Admin)
  else if (text.startsWith('/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ')) handleAddPersonnel(userId, text);
  else if (text.startsWith('/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ')) handleEditPersonnel(userId, text); // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  else if (text.startsWith('/‡∏•‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ')) handleDeletePersonnel(userId, text);
  else if (text === '/‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') handleViewAllPersonnel(event);

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£
  else if (text.startsWith('/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ ')) handleAddChild(userId, text);
  else if (text.startsWith('/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏ï‡∏£ ')) handleEditChild(userId, text);
  else if (text.startsWith('/‡∏•‡∏ö‡∏ö‡∏∏‡∏ï‡∏£ ')) handleDeleteChild(userId, text);
  else if (text === '/‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') handleViewAllChildren(event);

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏° (Admin) - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß
  else if (text.startsWith('/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£ ')) handleAddDuty(userId, text);
  else if (text.startsWith('/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏£ ')) handleEditDuty(userId, text);
  else if (text.startsWith('/‡∏•‡∏ö‡πÄ‡∏ß‡∏£ ')) handleDeleteDuty(userId, text);
  else if (text === '/‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') handleViewAllDuties(event);

  // **‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á**
  else if (text.startsWith('/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ')) handleAddCommand(userId, text);
  else if (text.startsWith('/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ')) handleEditCommand(userId, text);
  else if (text.startsWith('/‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ')) handleDeleteCommand(userId, text);
  else if (text.startsWith('/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ')) handleSearchCommand(userId, text);


  // ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
  else if (text === '/‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢') handleCompanyChildrenReport(event);
  else if (text === '/‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô') handleGenerateReport(event);

  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  else sendReply(userId, getHelpMessage());
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ LINE Bot
 * @returns {string} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
 */
function getHelpMessage() {
  return `ü§ñ **‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏´‡∏≤‡∏£ LINE Bot**

üìã **‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô**
‚Ä¢ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô <‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£>

üë§ **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß**
‚Ä¢ /‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
‚Ä¢ /‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á

‚è∞ **‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°**
‚Ä¢ /‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - ‡∏î‡∏π‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
‚Ä¢ /‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏î‡∏π‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
‚Ä¢ /‡πÄ‡∏ß‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á - ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏£
‚Ä¢ **‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥** - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏Å‡πà‡∏≠‡∏ô 8 ‡πÇ‡∏°‡∏á‡πÄ‡∏ä‡πâ‡∏≤ (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trigger ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)

üë∂ **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£**
‚Ä¢ /‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î>
‚Ä¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏ï‡∏£ <‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°>|<‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡∏°‡πà>
‚Ä¢ /‡∏•‡∏ö‡∏ö‡∏∏‡∏ï‡∏£ <‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•>
‚Ä¢ /‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

üë• **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•** (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î>
‚Ä¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£>|<‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå>|<‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà>
‚Ä¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°>|<‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢>|<‡∏¢‡∏®>|<‡∏ä‡∏∑‡πà‡∏≠>|<‡∏™‡∏Å‡∏∏‡∏•>|<‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô>|<‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£>|<‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î>|<‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á>|<‡πÄ‡∏´‡∏•‡πà‡∏≤>|<‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î>|<‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î>|<‡∏≠‡∏≤‡∏¢‡∏∏>|<‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô>|<‡∏ß‡∏±‡∏ô‡∏ö‡∏£‡∏£‡∏à‡∏∏>|<‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏¢‡∏®>|<‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô>|<‡∏õ‡∏µ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì>|<URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û>
‚Ä¢ /‡∏•‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£>
‚Ä¢ /‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

üõ°Ô∏è **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°** (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£ <‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î>
‚Ä¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏£ <‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà>|<‡∏ä‡∏∑‡πà‡∏≠>|<‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡∏°‡πà>
‚Ä¢ /‡∏•‡∏ö‡πÄ‡∏ß‡∏£ <‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà>|<‡∏ä‡∏∑‡πà‡∏≠>
‚Ä¢ /‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

üìú **‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á** (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö, ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
‚Ä¢ /‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏¢‡∏®>|<‡∏ä‡∏∑‡πà‡∏≠>|<‡∏™‡∏Å‡∏∏‡∏•>|<‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á>|<‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà>|<‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà(DD/MM/YYYY)>|<‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á>
‚Ä¢ /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°>|<‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°(DD/MM/YYYY)>|<‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà>|<‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà>|<‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà>|<‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà>|<‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà>|<‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà(DD/MM/YYYY)>|<‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà>
‚Ä¢ /‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà>|<‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà(DD/MM/YYYY)>
‚Ä¢ /‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î>

üìä **‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô** (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)
‚Ä¢ /‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢
‚Ä¢ /‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô

üí° **‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:**
‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ | ‡∏Ñ‡∏±‡πà‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ|01/01/2010|15|‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤|‡∏õ.6|‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà|3.25
        
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°): /‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£ 25/12/2567|‡∏à.‡∏™.‡∏≠.|‡∏™‡∏°‡∏ä‡∏≤‡∏¢|‡πÉ‡∏à‡∏î‡∏µ|‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏ï‡∏π|‡∏£.1|081-234-5678`;
}

/**
 * ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
 */
function sendReply(userId, text) {
  UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", {
    method: "post",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + CHANNEL_ACCESS_TOKEN
    },
    payload: JSON.stringify({
      to: userId,
      messages: [{ type: "text", text }]
    })
  });
}

/**
 * ‡∏™‡πà‡∏á Flex Message ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {string} userId - LINE User ID
 * @param {object} flexContent - ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message
 */
function sendFlex(userId, flexContent) {
  UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", {
    method: "post",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + CHANNEL_ACCESS_TOKEN
    },
    payload: JSON.stringify({
      to: userId,
      messages: [
        {
          type: "flex",
          altText: "üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          contents: flexContent
        }
      ]
    })
  });
}

/**
 * ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
 */
function handleRegistration(userId, text) {
  const loginSheet = SpreadsheetApp.getActive().getSheetByName('LOGIN');
  const loginData = loginSheet.getDataRange().getValues();
  const parts = text.split(' ');

  if (parts.length !== 2 || parts[0] !== '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô') {
    return sendReply(userId, '‚ùó ‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô <‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£>\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô 1565601540');
  }

  const militaryId = parts[1];
  const exists = loginData.some(row => row[0] === userId);
  const alreadyUsed = loginData.some(row => row[1] === militaryId);

  if (alreadyUsed) {
    return sendReply(userId, '‚ùå ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
  }

  if (exists) {
    for (let i = 1; i < loginData.length; i++) {
      if (loginData[i][0] === userId) {
        loginSheet.getRange(i + 1, 2).setValue(militaryId);
        return sendReply(userId, '‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      }
    }
  } else {
    loginSheet.appendRow([userId, militaryId]);
    return sendReply(userId, '‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß');
  }
}

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£
 */
function handleAddChild(userId, text) {
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  const parts = text.replace('/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ ', '').split('|');
  if (parts.length !== 7) {
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    
üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ <‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•>|<‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î(DD/MM/YYYY)>|<‡∏≠‡∏≤‡∏¢‡∏∏>|<‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤>|<‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô>|<‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤>|<‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô>

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏ï‡∏£ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ|01/01/2010|14|‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô|‡∏°.2|‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà|3.25`);
  }

  const [name, birthdate, age, educationLevel, grade, school, result] = parts.map(p => p.trim());

  const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
  childSheet.appendRow([militaryId, name, birthdate, age, educationLevel, grade, school, result]);

  sendReply(userId, `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£ "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}

/**
 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏ï‡∏£
 */
function handleEditChild(userId, text) {
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  const parts = text.replace('/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏ï‡∏£ ', '').split('|');
  if (parts.length !== 8) {
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    
üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏ï‡∏£ <‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°>|<‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà>|<‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î>|<‡∏≠‡∏≤‡∏¢‡∏∏>|<‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤>|<‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô>|<‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤>|<‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô>

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏ï‡∏£ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ|‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ|01/01/2010|15|‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô|‡∏°.3|‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà|3.50`);
  }

  const [oldName, newName, birthdate, age, educationLevel, grade, school, result] = parts.map(p => p.trim());

  const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
  const data = childSheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == militaryId && data[i][1] === oldName) {
      childSheet.getRange(i + 1, 2, 1, 7).setValues([[newName, birthdate, age, educationLevel, grade, school, result]]);
      return sendReply(userId, `‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£ "${oldName}" ‡πÄ‡∏õ‡πá‡∏ô "${newName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    }
  }

  sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
}

/**
 * ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡∏ö‡∏∏‡∏ï‡∏£
 */
function handleDeleteChild(userId, text) {
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  const childName = text.replace('/‡∏•‡∏ö‡∏ö‡∏∏‡∏ï‡∏£ ', '').trim();
  if (!childName) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: /‡∏•‡∏ö‡∏ö‡∏∏‡∏ï‡∏£ <‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•>\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡∏•‡∏ö‡∏ö‡∏∏‡∏ï‡∏£ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ');
  }

  const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
  const data = childSheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == militaryId && data[i][1] === childName) {
      childSheet.deleteRow(i + 1);
      return sendReply(userId, `‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£ "${childName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    }
  }

  sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
}

/**
 * ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handleViewAllChildren(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
  const children = childSheet.getDataRange().getValues()
    .slice(1)
    .filter(row => row[0] == militaryId);

  if (children.length === 0) {
    return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ');
  }

  let message = 'üë∂ **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î**\n\n';
  children.forEach((child, index) => {
    message += `${index + 1}. ${child[1]}\n`;
    message += `    üìÖ ‡πÄ‡∏Å‡∏¥‡∏î : ${child[2]} (‡∏≠‡∏≤‡∏¢‡∏∏ ${child[3]} ‡∏õ‡∏µ)\n`;
    message += `    üéì ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ : ${child[4]}\n`;
    message += `    üéì ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ : ${child[5]}\n`;
    message += `    üè´ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ : ${child[6]}\n`;
    message += `    üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô : ${child[7]}\n\n`;
  });

  sendReply(userId, message);
}

/**
 * ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY (‡∏û.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ.‡∏®.) ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ Date
 * @param {string} dateString - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY
 * @returns {Date|null} ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ Date ‡∏´‡∏£‡∏∑‡∏≠ null ‡∏´‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
 */
function parseThaiDateToDateObject(dateString) {
  const parts = dateString.split('/');
  if (parts.length !== 3) return null;

  let day = parseInt(parts[0], 10);
  let month = parseInt(parts[1], 10);
  let year = parseInt(parts[2], 10);

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 2500 ‡πÉ‡∏´‡πâ‡∏•‡∏ö 543)
  if (year > 2500) { // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏õ‡∏µ ‡∏û.‡∏®. ‡∏à‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 2500
    year -= 543;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Date object (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô JavaScript ‡πÄ‡∏õ‡πá‡∏ô 0-indexed)
  const date = new Date(year, month - 1, day);

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô 31 ‡∏Å.‡∏û.)
  if (date.getDate() !== day || date.getMonth() + 1 !== month || date.getFullYear() !== year) {
    return null; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  }
  return date;
}

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏° (Admin Only)
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£
 */
function handleAddDuty(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°');
  }

  const parts = text.replace('/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£ ', '').split('|');
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (7 ‡∏ü‡∏¥‡∏•‡∏î‡πå)
  if (parts.length !== 7) {
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    
üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£ <‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ(‡∏û.‡∏®.)>|<‡∏¢‡∏®>|<‡∏ä‡∏∑‡πà‡∏≠>|<‡∏™‡∏Å‡∏∏‡∏•>|<‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà>|<‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢>|<‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£>

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏£ 25/12/2567|‡∏à.‡∏™.‡∏≠.|‡∏™‡∏°‡∏ä‡∏≤‡∏¢|‡πÉ‡∏à‡∏î‡∏µ|‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏ï‡∏π|‡∏£.1|081-234-5678`);
  }

  const [dateStr, rank, firstName, lastName, duty, company, phone] = parts.map(p => p.trim());

  // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Date object)
  const dutyDate = parseThaiDateToDateObject(dateStr);
  if (!dutyDate) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ DD/MM/YYYY (‡πÄ‡∏ä‡πà‡∏ô 25/12/2567)');
  }

  // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY (‡∏û.‡∏®.) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ä‡∏µ‡∏ï
  const formattedDate = Utilities.formatDate(dutyDate, 'Asia/Bangkok', 'dd/MM/yyyy');

  const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
  dutySheet.appendRow([formattedDate, rank, firstName, lastName, duty, company, phone]);

  sendReply(userId, `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏° "${rank} ${firstName} ${lastName}" ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}

/**
 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏° (Admin Only)
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏£
 */
function handleEditDuty(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°');
  }

  const parts = text.replace('/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏£ ', '').split('|');
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (9 ‡∏ü‡∏¥‡∏•‡∏î‡πå)
  if (parts.length !== 9) { // 3 (old) + 6 (new) = 9
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    
üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏£ <‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°(‡∏û.‡∏®.)>|<‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°>|<‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°>|<‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà(‡∏û.‡∏®.)>|<‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà>|<‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà>|<‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà>|<‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà>|<‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡∏°‡πà>|<‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡∏°‡πà>

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏£ 25/12/2567|‡∏™‡∏°‡∏ä‡∏≤‡∏¢|‡πÉ‡∏à‡∏î‡∏µ|26/12/2567|‡∏à.‡∏™.‡∏ó.|‡∏™‡∏°‡∏ä‡∏≤‡∏¢|‡πÉ‡∏à‡∏î‡∏µ|‡πÄ‡∏ß‡∏£‡∏´‡∏•‡∏±‡∏á|‡∏£.1|081-234-5678`);
  }

  const [oldDateStr, oldFirstName, oldLastName, newDateStr, newRank, newFirstName, newLastName, newDuty, newCompany, newPhone] = parts.map(p => p.trim());

  // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
  const oldDutyDate = parseThaiDateToDateObject(oldDateStr);
  if (!oldDutyDate) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ DD/MM/YYYY (‡πÄ‡∏ä‡πà‡∏ô 25/12/2567)');
  }
  const formattedOldDate = Utilities.formatDate(oldDutyDate, 'Asia/Bangkok', 'dd/MM/yyyy');

  const newDutyDate = parseThaiDateToDateObject(newDateStr);
  if (!newDutyDate) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ DD/MM/YYYY (‡πÄ‡∏ä‡πà‡∏ô 26/12/2567)');
  }
  const formattedNewDate = Utilities.formatDate(newDutyDate, 'Asia/Bangkok', 'dd/MM/yyyy');

  const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
  const data = dutySheet.getDataRange().getValues();

  let foundAndEdited = false;
  for (let i = 1; i < data.length; i++) {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
    if (data[i][0] === formattedOldDate && data[i][2] === oldFirstName && data[i][3] === oldLastName) {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
      dutySheet.getRange(i + 1, 1, 1, 7).setValues([[formattedNewDate, newRank, newFirstName, newLastName, newDuty, newCompany, newPhone]]);
      foundAndEdited = true;
      break; // ‡∏û‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏õ
    }
  }

  if (foundAndEdited) {
    sendReply(userId, `‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏Ç‡∏≠‡∏á ${oldFirstName} ${oldLastName} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedOldDate} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
  } else {
    sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
  }
}

/**
 * ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏° (Admin Only)
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡πÄ‡∏ß‡∏£
 */
function handleDeleteDuty(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°');
  }

  const parts = text.replace('/‡∏•‡∏ö‡πÄ‡∏ß‡∏£ ', '').split('|');
  if (parts.length !== 3) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏Å‡∏∏‡∏•
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: /‡∏•‡∏ö‡πÄ‡∏ß‡∏£ <‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ(‡∏û.‡∏®.)>|<‡∏ä‡∏∑‡πà‡∏≠>|<‡∏™‡∏Å‡∏∏‡∏•>\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡∏•‡∏ö‡πÄ‡∏ß‡∏£ 25/12/2567|‡∏™‡∏°‡∏ä‡∏≤‡∏¢|‡πÉ‡∏à‡∏î‡∏µ');
  }

  const [dateStr, firstName, lastName] = parts.map(p => p.trim());

  // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
  const dutyDate = parseThaiDateToDateObject(dateStr);
  if (!dutyDate) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ DD/MM/YYYY (‡πÄ‡∏ä‡πà‡∏ô 25/12/2567)');
  }
  const formattedDate = Utilities.formatDate(dutyDate, 'Asia/Bangkok', 'dd/MM/yyyy');

  const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
  const data = dutySheet.getDataRange().getValues();

  let foundAndDeleted = false;
  for (let i = 1; i < data.length; i++) {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏∏‡∏•
    if (data[i][0] === formattedDate && data[i][2] === firstName && data[i][3] === lastName) {
      dutySheet.deleteRow(i + 1);
      foundAndDeleted = true;
      break;
    }
  }

  if (foundAndDeleted) {
    sendReply(userId, `‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏° "${firstName} ${lastName}" ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
  } else {
    sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
  }
}

/**
 * ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Admin Only)
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handleViewAllDuties(e) {
  const userId = e.source.userId;
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
  }

  const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
  const duties = dutySheet.getDataRange().getValues().slice(1);

  if (duties.length === 0) {
    return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°');
  }

  let message = 'üõ°Ô∏è **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î**\n\n';
  duties.slice(0, 20).forEach((duty, index) => { // ‡πÅ‡∏™‡∏î‡∏á 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
    message += `${index + 1}. ${duty[0]} - ${duty[1]} ${duty[2]} ${duty[3]}\n`;
    message += `    üìç ${duty[4]} | ${duty[5]} | ‚òéÔ∏è ${duty[6]}\n\n`;
  });

  if (duties.length > 20) {
    message += `\n... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${duties.length - 20} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  }

  sendReply(userId, message);
}

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• (Admin Only)
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•
 */
function handleAddPersonnel(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  }

  const parts = text.replace('/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ', '').split('|');
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (17 ‡∏ü‡∏¥‡∏•‡∏î‡πå)
  if (parts.length !== 17) { // ‡πÄ‡∏û‡∏¥‡πà‡∏° 1 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    
üìù ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 17 ‡∏ü‡∏¥‡∏•‡∏î‡πå:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢>|<‡∏¢‡∏®>|<‡∏ä‡∏∑‡πà‡∏≠>|<‡∏™‡∏Å‡∏∏‡∏•>|<‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô>|<‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£>|<‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î>|<‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á>|<‡πÄ‡∏´‡∏•‡πà‡∏≤>|<‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î>|<‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î>|<‡∏≠‡∏≤‡∏¢‡∏∏>|<‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô>|<‡∏ß‡∏±‡∏ô‡∏ö‡∏£‡∏£‡∏à‡∏∏>|<‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏¢‡∏®>|<‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô>|<‡∏õ‡∏µ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì>|<URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û>

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ‡∏£.1|‡∏à.‡∏™.‡∏≠.|‡∏™‡∏°‡∏ä‡∏≤‡∏¢|‡πÉ‡∏à‡∏î‡∏µ|1234567890123|1565601540|‡∏Å‡∏£‡∏° ‡∏ó‡∏û.21|‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å|‡∏£‡∏≤‡∏ö|‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø|01/01/1985|39|01/01/2005|01/01/2006|01/01/2010|35000|2545|https://example.com/profile.jpg`);
  }

  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  personnelSheet.appendRow(parts.map(p => p.trim()));

  sendReply(userId, `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• "${parts[1]} ${parts[2]} ${parts[3]}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}

/**
 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• (Admin Only)
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•
 */
function handleEditPersonnel(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  }

  const cleanText = text.replace('/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ', '');
  const parts = cleanText.split('|');

  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  const data = personnelSheet.getDataRange().getValues();
  // Headers are in row 0 (index 0) if you need them for dynamic mapping, but we'll use a fixed map for simplicity
  // const headers = data[0]; 

  // Define a mapping from user-friendly field names to column indices (0-based)
  // These keys should match what the user types, and values should match sheet column index
  const personnelFieldMap = {
    "‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢": 0,
    "‡∏¢‡∏®": 1,
    "‡∏ä‡∏∑‡πà‡∏≠": 2,
    "‡∏™‡∏Å‡∏∏‡∏•": 3,
    "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ‡∏õ‡∏ä‡∏ä.": 4,
    "‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£": 5,
    "‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î": 6,
    "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á": 7,
    "‡πÄ‡∏´‡∏•‡πà‡∏≤": 8,
    "‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î": 9,
    "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î": 10,
    "‡∏≠‡∏≤‡∏¢‡∏∏": 11,
    "‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô": 12,
    "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏à‡∏∏": 13,
    "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏á‡∏¢‡∏®": 14,
    "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô": 15, // Mapping "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" to "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" column
    "‡∏õ‡∏µ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì": 16,
    "URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û": 17 // Mapping "URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" to "URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" column
  };

  // --- Handle Partial Update (3 parts: militaryId | fieldName | newValue) ---
  if (parts.length === 3) {
    const [militaryId, fieldName, newValue] = parts.map(p => p.trim());

    if (!militaryId || !fieldName || newValue === undefined) {
      return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£>|<‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå>|<‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà>\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• 1565601540|‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô|‡∏õ.2/28 (20,950.00)`);
    }

    // Convert fieldName to its corresponding column index
    const colIndex = personnelFieldMap[fieldName];
    if (colIndex === undefined) {
      return sendReply(userId, `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå "${fieldName}" ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
    }

    let foundAndEdited = false;
    for (let i = 1; i < data.length; i++) { // Start from row 1 (index 1) to skip header
      // Find the row by '‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£' (which is at index 5 in the data array)
      if (String(data[i][5]).trim() === String(militaryId).trim()) {
        // Update only the specific cell
        personnelSheet.getRange(i + 1, colIndex + 1).setValue(newValue);
        foundAndEdited = true;
        break; // Exit loop once found and updated
      }
    }

    if (foundAndEdited) {
      sendReply(userId, `‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£ "${militaryId}" ‡∏ü‡∏¥‡∏•‡∏î‡πå "${fieldName}" ‡πÄ‡∏õ‡πá‡∏ô "${newValue}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    } else {
      sendReply(userId, `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£ "${militaryId}" ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏`);
    }
  }
  // --- Handle Full Row Update (18 parts: oldMilitaryId | newCompany | ... | newImageUrl) ---
  else if (parts.length === 18) {
    const oldMilitaryId = parts[0].trim();
    const newData = parts.slice(1).map(p => p.trim()); // New 17 fields

    let foundAndEdited = false;
    for (let i = 1; i < data.length; i++) { // Start from row 1 (index 1) to skip header
      // Find the row by '‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£' (which is at index 5 in the data array)
      if (String(data[i][5]).trim() === String(oldMilitaryId).trim()) {
        // Update the entire row starting from column 1 (index 0)
        personnelSheet.getRange(i + 1, 1, 1, newData.length).setValues([newData]);
        foundAndEdited = true;
        break; // Exit loop once found and updated
      }
    }

    if (foundAndEdited) {
      sendReply(userId, `‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£ "${oldMilitaryId}" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    } else {
      sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
    }
  }
  // --- Invalid Format ---
  else {
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    
üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå:
/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£>|<‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå>|<‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà>
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• 1565601540|‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô|‡∏õ.2/28 (20,950.00)

üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (17 ‡∏ü‡∏¥‡∏•‡∏î‡πå):
/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°>|<‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢>|<‡∏¢‡∏®>|<‡∏ä‡∏∑‡πà‡∏≠>|<‡∏™‡∏Å‡∏∏‡∏•>|<‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô>|<‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£>|<‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î>|<‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á>|<‡πÄ‡∏´‡∏•‡πà‡∏≤>|<‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î>|<‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î>|<‡∏≠‡∏≤‡∏¢‡∏∏>|<‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô>|<‡∏ß‡∏±‡∏ô‡∏ö‡∏£‡∏£‡∏à‡∏∏>|<‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏¢‡∏®>|<‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô>|<‡∏õ‡∏µ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì>|<URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û>`);
  }
}

/**
 * ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• (Admin Only)
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•
 */
function handleDeletePersonnel(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  }

  const militaryIdToDelete = text.replace('/‡∏•‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ', '').trim();
  if (!militaryIdToDelete) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: /‡∏•‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• <‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£>\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡∏•‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• 1565601540');
  }

  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  const data = personnelSheet.getDataRange().getValues();

  let foundAndDeleted = false;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][5]).trim() === String(militaryIdToDelete).trim()) {
      personnelSheet.deleteRow(i + 1);
      foundAndDeleted = true;
      break;
    }
  }

  if (foundAndDeleted) {
    sendReply(userId, `‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£ "${militaryIdToDelete}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
  } else {
    sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
  }
}

/**
 * ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Admin Only)
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handleViewAllPersonnel(e) {
  const userId = e.source.userId;
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
  }

  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  const personnel = personnelSheet.getDataRange().getValues().slice(1);

  if (personnel.length === 0) {
    return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  }

  let message = 'üë• **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î**\n\n';
  personnel.slice(0, 15).forEach((person, index) => { // ‡πÅ‡∏™‡∏î‡∏á 15 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
    message += `${index + 1}. ${person[1]} ${person[2]} ${person[3]}\n`;
    message += `    üÜî ${person[5]} | ${person[0]} | ${person[7]}\n`;
    message += `    üìÖ ‡∏≠‡∏≤‡∏¢‡∏∏ ${person[16]} ‡∏õ‡∏µ | ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì ${person[17]}\n\n`;
  });

  if (personnel.length > 15) {
    message += `\n... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${personnel.length - 15} ‡∏Ñ‡∏ô`;
  }

  sendReply(userId, message);
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Flex Message
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handleCommandChildInfo(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
  const children = childSheet.getDataRange().getValues().slice(1).filter(row => row[0] == militaryId);

  if (children.length === 0) return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ');

  children.forEach(child => {
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô Flex Message
    sendFlexChildInfo(userId, child[1], child[3], child[6], child[5], child[7]);
  });
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á Flex Message ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£
 * (‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Flex Message ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô)
 */
function sendFlexChildInfo(userId, name, age, school, grade, result) {
  const flex = {
    type: "bubble",
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "üë∂ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£",
          weight: "bold",
          color: "#007bff",
          size: "lg",
          align: "center"
        },
        {
          type: "separator",
          margin: "md"
        },
        {
          type: "text",
          text: `‡∏ä‡∏∑‡πà‡∏≠: ${name}`,
          size: "md",
          wrap: true
        },
        {
          type: "text",
          text: `‡∏≠‡∏≤‡∏¢‡∏∏: ${age} ‡∏õ‡∏µ`,
          size: "sm",
          color: "#666666"
        },
        {
          type: "text",
          text: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${school}`,
          size: "sm",
          color: "#666666",
          wrap: true
        },
        {
          type: "text",
          text: `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: ${grade}`,
          size: "sm",
          color: "#666666"
        },
        {
          type: "text",
          text: `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${result}`,
          size: "sm",
          color: "#666666"
        }
      ]
    }
  };
  sendFlex(userId, flex);
}


/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Flex Message
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handleCommandPersonnelInfo(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  const pData = personnelSheet.getDataRange().getValues();

  
  for (let i = 1; i < pData.length; i++) {
    if (String(pData[i][5]).trim() === String(militaryId).trim()) {
      const data = pData[i];
      const imageUrl = data[18];
      // Flex Message Structure provided by the user, with corrections for data indexing
      const flex = {
        type: "bubble",
        size: "giga",
        body: {
          type: "box",
          layout: "vertical",
          contents: [
            {
              type: "image",
              url: imageUrl, // Placeholder image URL
              size: "full",
              aspectMode: "cover",
              aspectRatio: "1:1",         
              gravity: "center"
            },
            {
              type: "box",
              layout: "vertical",
              spacing: "sm",
              paddingAll: "lg",
              contents: [
                {
                  type: "text",
                  text: "ü™ñ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•",
                  weight: "bold",
                  color: "#1DB446",
                  size: "lg",
                  align: "center"
                },
                {
                  type: "separator",
                  margin: "md"
                },
                {
                  type: "text",
                  text: `${data[1]} ${data[2]} ${data[3]}`, // ‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠ ‡∏™‡∏Å‡∏∏‡∏•
                  weight: "bold",
                  size: "lg",
                  align: "center",
                  margin: "md"
                },
                {
                  type: "box",
                  layout: "vertical",
                  margin: "md",
                  spacing: "xs",
                  contents: [
                    { type: "text", text: `üìå ‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢ : ${data[0]}`, size: "sm", wrap: true },
                    { type: "text", text: `üÜî ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ‡∏õ‡∏ä‡∏ä. : ${data[4]}`, size: "sm", wrap: true },
                    { type: "text", text: `ü™ñ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£ : ${data[5]}`, size: "sm", wrap: true },
                    { type: "text", text: `üìç ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î : ${data[6]}`, size: "sm", wrap: true },
                    { type: "text", text: `üéñÔ∏è ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á : ${data[7]}`, size: "sm", wrap: true },
                    { type: "text", text: `üî∞ ‡πÄ‡∏´‡∏•‡πà‡∏≤ : ${data[8]}`, size: "sm", wrap: true },
                    { type: "text", text: `üè† ‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î : ${data[9]}`, size: "sm", wrap: true },
                    { type: "text", text: `üéÇ ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î : ${data[10]}`, size: "sm", wrap: true },
                    { type: "text", text: `‚è≥ ‡∏≠‡∏≤‡∏¢‡∏∏ : ${data[16]} ‡∏õ‡∏µ`, size: "sm", wrap: true }, // Corrected index from data[16] to data[11]
                    { type: "text", text: `üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô : ${data[12]}`, size: "sm", wrap: true },
                    { type: "text", text: `üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏à‡∏∏ : ${data[13]}`, size: "sm", wrap: true },
                    { type: "text", text: `üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏á‡∏¢‡∏® : ${data[14]}`, size: "sm", wrap: true },
                    { type: "text", text: `üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô : ${data[15]}`, size: "sm", wrap: true },
                    { type: "text", text: `üìÜ ‡∏õ‡∏µ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì : ${data[17]}`, size: "sm", wrap: true } // Corrected index from data[17] to data[16]
                  ]
                }
              ]
            }
          ]
        },
        styles: {
          body: {
            separator: true
          }
        }
      };
      sendFlex(userId, flex);
      return;
    }
  }
  sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
}

/**
 * Helper function ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Box ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Key-Value
 * @param {string} key - ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå
 * @param {string} value - ‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 * @returns {object} Flex Message Box component
 */
function createKeyValueBox(key, value) {
  return {
    type: "box",
    layout: "horizontal",
    contents: [
      {
        type: "text",
        text: key,
        size: "sm",
        color: "#555555",
        flex: 3
      },
      {
        type: "text",
        text: value,
        size: "sm",
        color: "#111111",
        wrap: true,
        flex: 7,
        align: "end"
      }
    ]
  };
}



/**
 * Helper function ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Box ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Key-Value
 * @param {string} key - ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå
 * @param {string} value - ‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 * @returns {object} Flex Message Box component
 */
function createKeyValueBox(key, value) {
  return {
    type: "box",
    layout: "horizontal",
    contents: [
      {
        type: "text",
        text: key,
        size: "sm",
        color: "#555555",
        flex: 3
      },
      {
        type: "text",
        text: value,
        size: "sm",
        color: "#111111",
        wrap: true,
        flex: 7,
        align: "end"
      }
    ]
  };
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handleCommandDutyToday(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  const pdata = personnelSheet.getDataRange().getValues();
  const ddata = dutySheet.getDataRange().getValues();

  let name = '';
  for (let i = 1; i < pdata.length; i++) {
    if (String(pdata[i][5]).trim() === String(militaryId).trim()) {
      name = pdata[i][2];
      break;
    }
  }
  if (!name) return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');

  const today = Utilities.formatDate(new Date(), 'Asia/Bangkok', 'dd/MM/yyyy');
  let foundDuty = false;

  ddata.slice(1).forEach(row => {
    if (row[0] && row[2]) {
      let dutyDateStr = '';

      if (row[0] instanceof Date) {
        dutyDateStr = Utilities.formatDate(row[0], 'Asia/Bangkok', 'dd/MM/yyyy');
      } else {
        dutyDateStr = row[0].toString();
      }

      if (dutyDateStr === today && row[2] === name) {
        const fullName = `${row[1]} ${row[2]} ${row[3]}`;
        const duty = row[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
        const company = row[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢';
        const phone = row[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£';

        sendFlexDutyReminder(userId, fullName, duty, company, phone);
        foundDuty = true;
      }
    }
  });

  if (!foundDuty) {
    sendReply(userId, '‚úÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°');
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á Flex Message ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°
 */
function sendFlexDutyReminder(userId, fullName, duty, company, phone) {
  const flex = {
    type: "bubble",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "‚è∞ ‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
          weight: "bold",
          color: "#ffffff",
          size: "lg",
          align: "center"
        }
      ],
      backgroundColor: "#FF5722", // ‡∏™‡∏µ‡∏™‡πâ‡∏°
      paddingAll: "md"
    },
    body: {
      type: "box",
      layout: "vertical",
      spacing: "md",
      contents: [
        {
          type: "text",
          text: `üë§ ${fullName}`,
          weight: "bold",
          size: "md",
          align: "center"
        },
        {
          type: "separator",
          margin: "md"
        },
        createKeyValueBox("‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà", duty),
        createKeyValueBox("‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢", company),
        createKeyValueBox("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", phone)
      ]
    }
  };
  sendFlex(userId, flex);
}


/**
 * ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handleMonthlyDuty(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  const pdata = personnelSheet.getDataRange().getValues();
  const ddata = dutySheet.getDataRange().getValues();

  let name = '';
  for (let i = 1; i < pdata.length; i++) {
    if (String(pdata[i][5]).trim() === String(militaryId).trim()) {
      name = pdata[i][2];
      break;
    }
  }
  if (!name) return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');

  const currentMonth = new Date().getMonth() + 1;
  const currentYear = new Date().getFullYear();
  const monthlyDuties = [];

  ddata.slice(1).forEach(row => {
    if (row[0] && row[2]) {
      let dutyDate;

      if (row[0] instanceof Date) {
        dutyDate = row[0];
      } else {
        const dateStr = row[0].toString();
        const [day, month, year] = dateStr.split('/');
        // Convert BE year to AD year if needed for Date object creation
        const adYear = parseInt(year) > 2500 ? parseInt(year) - 543 : parseInt(year);
        dutyDate = new Date(adYear, parseInt(month) - 1, parseInt(day));
      }

      if (dutyDate.getMonth() + 1 === currentMonth &&
          dutyDate.getFullYear() === currentYear &&
          row[2] === name) {
        monthlyDuties.push({
          date: Utilities.formatDate(dutyDate, 'Asia/Bangkok', 'dd/MM/yyyy'),
          rank: row[1] || '',
          position: row[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà',
          company: row[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢',
          phone: row[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'
        });
      }
    }
  });

  if (monthlyDuties.length === 0) {
    return sendReply(userId, 'üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°');
  }

  const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                      '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

  const flex = {
    type: 'bubble',
    size: 'mega',
    header: {
      type: 'box',
      layout: 'vertical',
      contents: [
        { type: 'text', text: `üìÖ ‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${monthNames[currentMonth-1]}`, weight: 'bold', color: '#ffffff', size: 'lg' }
      ],
      backgroundColor: '#FF9800'
    },
    body: {
      type: 'box',
      layout: 'vertical',
      spacing: 'md',
      contents: [
        { type: 'text', text: `üë§ ${monthlyDuties[0].rank} ${name}`, weight: 'bold', size: 'md' },
        { type: 'separator', margin: 'md' },
        ...monthlyDuties.map(duty => ({
          type: 'box',
          layout: 'vertical',
          margin: 'sm',
          contents: [
            { type: 'text', text: `üìÖ ${duty.date}`, size: 'sm', weight: 'bold' },
            { type: 'text', text: `üìç ${duty.position}`, size: 'xs', color: '#666666' },
            { type: 'text', text: `üè¢ ${duty.company}`, size: 'xs', color: '#666666' },
            { type: 'text', text: `‚òéÔ∏è ${duty.phone}`, size: 'xs', color: '#666666' }
          ]
        }))
      ]
    }
  };

  sendFlex(userId, flex);
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handlePastDuties(e) {
  const userId = e.source.userId;
  const militaryId = getUserMilitaryId(userId);
  if (!militaryId) return sendReply(userId, '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

  const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  const pdata = personnelSheet.getDataRange().getValues();
  const ddata = dutySheet.getDataRange().getValues();

  let name = '';
  for (let i = 1; i < pdata.length; i++) {
    if (String(pdata[i][5]).trim() === String(militaryId).trim()) {
      name = pdata[i][2];
      break;
    }
  }
  if (!name) return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');

  const today = new Date();
  const pastDuties = [];

  ddata.slice(1).forEach(row => {
    if (row[0] && row[2]) {
      let dutyDate;

      if (row[0] instanceof Date) {
        dutyDate = row[0];
      } else {
        const dateStr = row[0].toString();
        const [day, month, year] = dateStr.split('/');
        // Convert BE year to AD year if needed for Date object creation
        const adYear = parseInt(year) > 2500 ? parseInt(year) - 543 : parseInt(year);
        dutyDate = new Date(adYear, parseInt(month) - 1, parseInt(day));
      }

      if (dutyDate < today && row[2] === name) {
        pastDuties.push({
          date: Utilities.formatDate(dutyDate, 'Asia/Bangkok', 'dd/MM/yyyy'),
          position: row[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà',
          company: row[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢',
          phone: row[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£',
          sortDate: dutyDate
        });
      }
    }
  });

  pastDuties.sort((a, b) => b.sortDate - a.sortDate);
  const recentDuties = pastDuties.slice(0, 10);

  if (recentDuties.length === 0) {
    return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á');
  }

  const flex = {
    type: 'bubble',
    size: 'mega',
    header: {
      type: 'box',
      layout: 'vertical',
      contents: [
        { type: 'text', text: 'üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á', weight: 'bold', color: '#ffffff', size: 'lg' }
      ],
      backgroundColor: '#9C27B0'
    },
    body: {
      type: 'box',
      layout: 'vertical',
      spacing: 'sm',
      contents: [
        { type: 'text', text: `üë§ ${name}`, weight: 'bold', size: 'md' },
        { type: 'separator', margin: 'md' },
        ...recentDuties.map(duty => ({
          type: 'box',
          layout: 'vertical',
          margin: 'xs',
          contents: [
            { type: 'text', text: `üìÖ ${duty.date} - ${duty.position}`, size: 'sm' },
            { type: 'text', text: `üè¢ ${duty.company}`, size: 'xs', color: '#666666' }
          ]
        }))
      ]
    }
  };

  sendFlex(userId, flex);
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢ (Admin Only)
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handleCompanyChildrenReport(e) {
  const userId = e.source.userId;
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ');
  }

  const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');

  if (!childSheet) {
    return sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó');
  }
  if (!personnelSheet) {
    return sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó');
  }

  const childData = childSheet.getDataRange().getValues();
  const personnelData = personnelSheet.getDataRange().getValues();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß header)
  if (childData.length <= 1 && personnelData.length <= 1) {
    return sendReply(userId, 'üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
  }
  
  // Skip header rows
  const children = childData.slice(1);
  const personnel = personnelData.slice(1);


  let report = 'üìä **‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢**\n\n';
  let totalChildren = 0;
  let schoolAgeChildren = 0;

  // Group children by military ID
  const childrenByMilitaryId = {};
  children.forEach(child => {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ child[0] ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    if (child[0]) {
      const militaryId = String(child[0]).trim(); // Column A (‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£)
      if (!childrenByMilitaryId[militaryId]) {
        childrenByMilitaryId[militaryId] = [];
      }
      childrenByMilitaryId[militaryId].push(child);
    }
  });

  // Iterate through personnel to find their children
  if (personnel.length === 0) {
      report += '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n\n';
  }

  personnel.forEach(person => {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ person[5] ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    if (person[5]) {
        const militaryId = String(person[5]).trim(); // Column F (‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£)
        const rank = person[1];
        const firstName = person[2];
        const lastName = person[3];
        const company = person[0]; // Column A (‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢)

        report += `**${rank || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏®'} ${firstName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'} ${lastName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏Å‡∏∏‡∏•'} (${company || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢'})**\n`;
        const childrenOfThisPersonnel = childrenByMilitaryId[militaryId] || [];

        if (childrenOfThisPersonnel.length > 0) {
            childrenOfThisPersonnel.forEach((child, index) => {
                const childName = child[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
                const childAge = parseInt(child[3], 10) || 0; // Column D (‡∏≠‡∏≤‡∏¢‡∏∏)
                const childEducationLevel = child[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; // Column E (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤)
                const childSchool = child[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; // Column G (‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤)

                report += `  ${index + 1}. ${childName} (‡∏≠‡∏≤‡∏¢‡∏∏ ${childAge} ‡∏õ‡∏µ)\n`;
                report += `     ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${childEducationLevel}, ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${childSchool}\n`;

                totalChildren++;
                if (childAge >= 6 && childAge <= 18) { // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    schoolAgeChildren++;
                }
            });
        } else {
            report += `  - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£\n`;
        }
        report += '\n'; // Add a blank line for readability between personnel
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ militaryId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô
        const rank = person[1];
        const firstName = person[2];
        const lastName = person[3];
        report += `**${rank || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏®'} ${firstName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'} ${lastName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏Å‡∏∏‡∏•'} (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£)**\n`;
        report += `  - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£\n\n`;
    }
  });

  report += `---
**‡∏™‡∏£‡∏∏‡∏õ:**
‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalChildren} ‡∏Ñ‡∏ô
‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡∏ß‡∏±‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (6-18 ‡∏õ‡∏µ): ${schoolAgeChildren} ‡∏Ñ‡∏ô`;

  sendReply(userId, report);
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin Only)
 * @param {object} e - Event object ‡∏à‡∏≤‡∏Å LINE
 */
function handleGenerateReport(e) {
  const userId = e.source.userId;
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ');
  }

  const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
  const childSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏ï‡∏£-‡∏ò‡∏¥‡∏î‡∏≤');
  const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
  const commandSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ'); // New sheet for commands

  const totalPersonnel = personnelSheet ? personnelSheet.getLastRow() - 1 : 0; // ‡∏•‡∏ö Header
  const totalChildren = childSheet ? childSheet.getLastRow() - 1 : 0; // ‡∏•‡∏ö Header
  const totalDuties = dutySheet ? dutySheet.getLastRow() - 1 : 0; // ‡∏•‡∏ö Header
  const totalCommands = commandSheet ? commandSheet.getLastRow() - 1 : 0; // New: total commands

  let report = `üìä **‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**\n\n`;
  report += `üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalPersonnel} ‡∏ô‡∏≤‡∏¢\n`;
  report += `üë∂ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalChildren} ‡∏Ñ‡∏ô\n`;
  report += `üõ°Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${totalDuties} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
  report += `üìú ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${totalCommands} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n`; // New
  report += `(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡πÑ‡∏î‡πâ)`;

  sendReply(userId, report);
}


/**
 * ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó LOGIN
 * @param {string} userId - LINE User ID
 * @returns {string|null} ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ó‡∏´‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ null ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
 */
function getUserMilitaryId(userId) {
  const loginSheet = SpreadsheetApp.getActive().getSheetByName('LOGIN');
  const loginData = loginSheet.getDataRange().getValues();
  for (let i = 1; i < loginData.length; i++) {
    if (loginData[i][0] === userId) {
      return loginData[i][1];
    }
  }
  return null;
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó ADMIN
 * @param {string} userId - LINE User ID
 * @returns {boolean} true ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö, false ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà
 */
function checkAdminPermission(userId) {
  try {
    const adminSheet = SpreadsheetApp.getActive().getSheetByName('ADMIN');
    if (!adminSheet) {
      Logger.log('Error: Sheet named "ADMIN" not found.');
      return false; // ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ
    }
    const adminData = adminSheet.getDataRange().getValues();
    // Assuming userId is in the first column (index 0) of the ADMIN sheet
    const adminUserIds = adminData.slice(1).map(row => String(row[0]).trim()); // Skip header, convert to string and trim

    return adminUserIds.includes(String(userId).trim());
  } catch (e) {
    Logger.log(`Error checking admin permission: ${e.message}`);
    return false;
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trigger (‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger)
 */
function createDailyDutyReminderTrigger() {
  // ‡∏•‡∏ö Trigger ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'sendDailyDutyReminder') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 7:00 AM ‡∏ñ‡∏∂‡∏á 8:00 AM (‡πÄ‡∏ß‡∏•‡∏≤ Asia/Bangkok)
  ScriptApp.newTrigger('sendDailyDutyReminder')
    .timeBased()
    .everyDays(1)
    .atHour(7) // ‡∏£‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 07:00 ‡∏ô.
    .nearMinute(30) // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 07:30 ‡∏ô. (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
    .inTimezone('Asia/Bkk') // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô Bkk ‡∏´‡∏≤‡∏Å Asia/Bangkok ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    .create();

  Logger.log('Daily duty reminder trigger created successfully.');
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (‡∏£‡∏±‡∏ô‡πÇ‡∏î‡∏¢ Trigger)
 */
function sendDailyDutyReminder() {
  const dutySheet = SpreadsheetApp.getActive().getSheetByName('‡πÄ‡∏ß‡∏£ - ‡∏¢‡∏≤‡∏°');
  const ddata = dutySheet.getDataRange().getValues();
  const today = Utilities.formatDate(new Date(), 'Asia/Bangkok', 'dd/MM/yyyy');

  const loginSheet = SpreadsheetApp.getActive().getSheetByName('LOGIN');
  const loginData = loginSheet.getDataRange().getValues();
  const militaryIdToUserId = {};
  loginData.slice(1).forEach(row => {
    militaryIdToUserId[row[1]] = row[0]; // Map militaryId to userId
  });

  ddata.slice(1).forEach(row => {
    if (row[0] && row[2]) {
      let dutyDateStr = '';
      if (row[0] instanceof Date) {
        dutyDateStr = Utilities.formatDate(row[0], 'Asia/Bangkok', 'dd/MM/yyyy');
      } else {
        dutyDateStr = row[0].toString();
      }

      if (dutyDateStr === today) {
        const rank = row[1];
        const firstName = row[2];
        const lastName = row[3];
        const duty = row[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
        const company = row[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢';
        const phone = row[6] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£';

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ militaryId ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•
        const personnelSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•');
        const pData = personnelSheet.getDataRange().getValues();
        let militaryIdFound = null;
        for (let i = 1; i < pData.length; i++) {
          if (pData[i][2] === firstName && pData[i][3] === lastName) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•
            militaryIdFound = pData[i][5]; // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£
            break;
          }
        }

        if (militaryIdFound && militaryIdToUserId[militaryIdFound]) {
          const targetUserId = militaryIdToUserId[militaryIdFound];
          const fullName = `${rank} ${firstName} ${lastName}`;
          sendFlexDutyReminder(targetUserId, fullName, duty, company, phone);
        } else {
          Logger.log(`‡πÑ‡∏°‡πà‡∏û‡∏ö LINE User ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${firstName} ${lastName} (‡πÄ‡∏•‡∏Ç‡∏ó‡∏´‡∏≤‡∏£: ${militaryIdFound})`);
        }
      }
    }
  });
}

// ====================================================================
// NEW FEATURES: Command Book Management
// ====================================================================

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Admin Only)
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 */
function handleAddCommand(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á');
  }

  const parts = text.replace('/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ', '').split('|');
  // Expected: ‡∏¢‡∏® | ‡∏ä‡∏∑‡πà‡∏≠ | ‡∏™‡∏Å‡∏∏‡∏• | ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á | ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà | ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà | ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
  if (parts.length !== 7) {
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    
üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏¢‡∏®>|<‡∏ä‡∏∑‡πà‡∏≠>|<‡∏™‡∏Å‡∏∏‡∏•>|<‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á>|<‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà>|<‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà(DD/MM/YYYY)>|<‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á>

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡∏à.‡∏™.‡∏≠.|‡∏™‡∏°‡∏ä‡∏≤‡∏¢|‡πÉ‡∏à‡∏î‡∏µ|‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏£‡∏¢‡∏≤‡∏°|‡∏ö‡∏Å.001/2568|25/07/2568|https://drive.google.com/link-to-file.pdf`);
  }

  const [rank, firstName, lastName, commandList, commandNumber, dateStr, fileLink] = parts.map(p => p.trim());

  // Validate date format
  const commandDate = parseThaiDateToDateObject(dateStr);
  if (!commandDate) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ DD/MM/YYYY (‡πÄ‡∏ä‡πà‡∏ô 25/07/2568)');
  }
  const formattedDate = Utilities.formatDate(commandDate, 'Asia/Bangkok', 'dd/MM/yyyy');

  const commandSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ');
  // Check for duplicate command number and date
  const data = commandSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][4] === commandNumber && data[i][5] === formattedDate) {
      return sendReply(userId, `‚ùå ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà ${commandNumber} ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
    }
  }

  commandSheet.appendRow([rank, firstName, lastName, commandList, commandNumber, formattedDate, fileLink]);
  sendReply(userId, `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "${commandList}" (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà ${commandNumber}) ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}

/**
 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Admin Only)
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 */
function handleEditCommand(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á');
  }

  const parts = text.replace('/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ', '').split('|');
  // Expected: ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° | ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° | ‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà | ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà | ‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà | ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà | ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà | ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà | ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
  if (parts.length !== 9) {
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    
üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°>|<‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°(DD/MM/YYYY)>|<‡∏¢‡∏®‡πÉ‡∏´‡∏°‡πà>|<‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà>|<‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà>|<‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà>|<‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà>|<‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà(DD/MM/YYYY)>|<‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà>

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡∏ö‡∏Å.001/2568|25/07/2568|‡∏£.‡∏ï.|‡∏™‡∏°‡∏®‡∏£‡∏µ|‡∏™‡∏∏‡∏Ç‡πÉ‡∏à|‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö|‡∏ö‡∏Å.002/2568|26/07/2568|https://drive.google.com/new-file.pdf`);
  }

  const [oldCommandNumber, oldDateStr, newRank, newFirstName, newLastName, newCommandList, newCommandNumber, newDateStrFormatted, newFileLink] = parts.map(p => p.trim());

  // Validate old and new dates
  const oldCommandDate = parseThaiDateToDateObject(oldDateStr);
  if (!oldCommandDate) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ DD/MM/YYYY (‡πÄ‡∏ä‡πà‡∏ô 25/07/2568)');
  }
  const formattedOldDate = Utilities.formatDate(oldCommandDate, 'Asia/Bangkok', 'dd/MM/yyyy');

  const newCommandDate = parseThaiDateToDateObject(newDateStrFormatted);
  if (!newCommandDate) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ DD/MM/YYYY (‡πÄ‡∏ä‡πà‡∏ô 26/07/2568)');
  }
  const formattedNewDate = Utilities.formatDate(newCommandDate, 'Asia/Bangkok', 'dd/MM/yyyy');

  const commandSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ');
  const data = commandSheet.getDataRange().getValues();

  let foundAndEdited = false;
  for (let i = 1; i < data.length; i++) {
    // Check old command number and date
    if (data[i][4] === oldCommandNumber && data[i][5] === formattedOldDate) {
      // Prepare new data array
      const newData = [newRank, newFirstName, newLastName, newCommandList, newCommandNumber, formattedNewDate, newFileLink];
      commandSheet.getRange(i + 1, 1, 1, newData.length).setValues([newData]);
      foundAndEdited = true;
      break;
    }
  }

  if (foundAndEdited) {
    sendReply(userId, `‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà ${oldCommandNumber} ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedOldDate} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
  } else {
    sendReply(userId, `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà ${oldCommandNumber} ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedOldDate} ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏`);
  }
}

/**
 * ‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Admin Only)
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 */
function handleDeleteCommand(userId, text) {
  if (!checkAdminPermission(userId)) {
    return sendReply(userId, '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á');
  }

  const parts = text.replace('/‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ', '').split('|');
  // Expected: ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà | ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  if (parts.length !== 2) {
    return sendReply(userId, `‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    
üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
/‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà>|<‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà(DD/MM/YYYY)>

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
/‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡∏ö‡∏Å.001/2568|25/07/2568`);
  }

  const [commandNumber, dateStr] = parts.map(p => p.trim());

  // Validate date format
  const commandDate = parseThaiDateToDateObject(dateStr);
  if (!commandDate) {
    return sendReply(userId, '‚ùó ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ DD/MM/YYYY (‡πÄ‡∏ä‡πà‡∏ô 25/07/2568)');
  }
  const formattedDate = Utilities.formatDate(commandDate, 'Asia/Bangkok', 'dd/MM/yyyy');

  const commandSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ');
  const data = commandSheet.getDataRange().getValues();

  let foundAndDeleted = false;
  for (let i = 1; i < data.length; i++) {
    // Check command number and date
    if (data[i][4] === commandNumber && data[i][5] === formattedDate) {
      commandSheet.deleteRow(i + 1);
      foundAndDeleted = true;
      break;
    }
  }

  if (foundAndDeleted) {
    sendReply(userId, `‚úÖ ‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà ${commandNumber} ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
  } else {
    sendReply(userId, `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà ${commandNumber} ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate} ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏`);
  }
}

/**
 * ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 * @param {string} userId - LINE User ID
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 */
function handleSearchCommand(userId, text) {
  const keyword = text.replace('/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ', '').trim().toLowerCase();
  if (!keyword) {
    return sendReply(userId, '‚ùó ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á');
  }

  const commandSheet = SpreadsheetApp.getActive().getSheetByName('‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ');
  if (!commandSheet) {
    return sendReply(userId, '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ"');
  }
  const allCommands = commandSheet.getDataRange().getValues().slice(1); // Skip header row

  const matchingCommands = [];
  allCommands.forEach(row => {
    // Assume 'row' (data from sheet) has elements in this order:
    // [0] ‡∏¢‡∏®, [1] ‡∏ä‡∏∑‡πà‡∏≠, [2] ‡∏™‡∏Å‡∏∏‡∏•, [3] ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á, [4] ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà), [5] ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, [6] ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á

    // Concatenate relevant fields for searching (lowercase for case-insensitive search)
    const searchableText = `${row[0]} ${row[1]} ${row[2]} ${row[3]} ${row[4]}`.toLowerCase();
    if (searchableText.includes(keyword)) {
      matchingCommands.push(row);
    }
  });

  if (matchingCommands.length === 0) {
    return sendReply(userId, `üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î "${keyword}"`);
  }

  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö
  sendReply(userId, `üìú ‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ${matchingCommands.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${keyword}"`);

  // ‡∏™‡πà‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Line ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
  matchingCommands.slice(0, 10).forEach(commandRow => {
    const rank = commandRow[0] || '';
    const firstName = commandRow[1] || '';
    const lastName = commandRow[2] || '';
    const commandList = commandRow[3] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'; // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Column D)
    const commandNumber = commandRow[4] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á'; // ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà) (Column E)
    const date = commandRow[5] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'; // ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Column F)
    const fileLink = commandRow[6] || ''; // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Column G)

    sendFlexCommandInfo(userId, rank, firstName, lastName, commandList, commandNumber, date, fileLink);
  });
  
  if (matchingCommands.length > 10) {
    sendReply(userId, `...‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏µ‡∏Å ${matchingCommands.length - 10} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô`);
  }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á Flex Message ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 * @param {string} userId - LINE User ID
 * @param {string} rank - ‡∏¢‡∏®
 * @param {string} firstName - ‡∏ä‡∏∑‡πà‡∏≠
 * @param {string} lastName - ‡∏™‡∏Å‡∏∏‡∏•
 * @param {string} commandList - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 * @param {string} commandNumber - ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà)
 * @param {string} date - ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
 * @param {string} fileLink - ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 */
function sendFlexCommandInfo(userId, rank, firstName, lastName, commandList, commandNumber, date, fileLink) {
  const flexContents = {
    type: "bubble",
    size: "giga",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "üìú ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á",
          weight: "bold",
          color: "#ffffff",
          size: "lg",
          align: "center"
        }
      ],
      backgroundColor: "#4CAF50", // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
      paddingAll: "md"
    },
    body: {
      type: "box",
      layout: "vertical",
      spacing: "sm",
      paddingAll: "xl",
      contents: [
        {
          type: "text",
          text: `${rank} ${firstName} ${lastName}`,
          weight: "bold",
          size: "md",
          wrap: true,
          color: "#333333"
        },
        {
          type: "separator",
          margin: "md",
          color: "#eeeeee"
        },
        createKeyValueBox("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á", commandList),
        createKeyValueBox("‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà", commandNumber),
        createKeyValueBox("‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", date)
      ]
    },
    footer: {
      type: "box",
      layout: "vertical",
      spacing: "sm",
      contents: [] // ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ fileLink
    }
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á" ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå
  if (fileLink && fileLink.startsWith('http')) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    flexContents.footer.contents.push({
      type: "button",
      style: "primary",
      height: "sm",
      action: {
        type: "uri",
        label: "üîó ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á",
        uri: fileLink
      }
    });
  } else {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á
    flexContents.footer.contents.push({
      type: "text",
      text: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á",
      size: "sm",
      color: "#999999",
      align: "center"
    });
  }

  sendFlex(userId, flexContents);
}
